<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prince Alex HR & Payroll</title>
    <!-- FontAwesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Define CSS Variables for consistent styling based on new UI/UX */
        :root {
            --primary-blue: #0056b3; /* Darker Blue for primary actions/branding */
            --accent-yellow: #ffcc00; /* Yellow for accents and highlights */
            --background-light: #f5f7fa; /* Very light gray for overall background */
            --card-background: #ffffff; /* White for card backgrounds */
            --text-dark: #333333; /* Dark text for readability */
            --text-light: #555555; /* Lighter text for secondary info */
            --border-light: #e0e0e0; /* Light grey for borders */
            --border-radius: 12px; /* Standard rounded corners for cards */
            --button-radius: 8px; /* Slightly smaller rounded corners for buttons */
            --box-shadow-light: 0 4px 12px rgba(0, 0, 0, 0.08); /* Subtle shadow effect for cards */
            --button-hover-dark: #004494; /* Darker blue on hover */
            --button-hover-yellow: #e6b800; /* Darker yellow on hover */
        }

        /* Dark Mode Variables */
        body.dark-mode {
            --primary-blue: #1a2a4b;
            --accent-yellow: #ffcc00;
            --background-light: #121212;
            --card-background: #1e1e1e;
            --text-dark: #e0e0e0;
            --text-light: #bbbbbb;
            --border-light: #333333;
            --box-shadow-light: 0 4px 12px rgba(0, 0, 0, 0.3);
            --button-hover-dark: #0f1c32;
        }

        /* Basic global styles */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: var(--background-light);
            color: var(--text-dark);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            display: flex; /* Use flexbox for main layout */
            min-height: 100vh; /* Ensure body takes full viewport height */
            transition: background-color 0.3s ease, color 0.3s ease; /* Smooth transition for dark mode */
            overflow-y: auto; /* Ensure body is the scroll container for the sticky header */
        }

        /* Sidebar styles */
        .sidebar {
            position: fixed;          /* Fix sidebar to the left */
            top: 0;
            left: 0;
            width: 250px;             /* Fixed width */
            height: 100vh;            /* Full viewport height */
            background-color: var(--primary-blue);
            color: white;
            padding: 1.5rem 0;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 100;             /* Stay above content */
            overflow-y: auto;         /* Scroll if sidebar content is long */
            transition: transform 0.3s ease-in-out, background-color 0.3s ease; /* Smooth transition for mobile toggle and dark mode */
        }

        .sidebar h2 {
            text-align: center;
            margin-bottom: 2rem;
            font-size: 1.6rem;
            color: var(--accent-yellow);
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1; /* Occupy available space */
        }

        .sidebar ul li {
            margin-bottom: 0.5rem;
        }

        .sidebar ul li a {
            display: flex;
            align-items: center;
            padding: 0.8rem 1.5rem;
            color: white;
            text-decoration: none;
            font-size: 1.05rem;
            transition: background-color 0.3s ease, padding-left 0.3s ease;
            border-left: 5px solid transparent;
        }

        .sidebar ul li a i {
            margin-right: 10px;
            font-size: 1.1em;
        }

        .sidebar ul li a:hover,
        .sidebar ul li a.active {
            background-color: rgba(255, 255, 255, 0.15);
            border-left: 5px solid var(--accent-yellow);
            padding-left: 2rem;
        }

        /* Content area styles */
        .content-area {
            margin-left: 250px;       /* Push content so it doesnâ€™t overlap */
            flex-grow: 1;
            /* Removed overflow-y: auto; to allow body to scroll */
            background-color: var(--background-light);
            min-height: 100vh;
            transition: margin-left 0.3s ease-in-out, background-color 0.3s ease; /* Smooth transition for mobile and dark mode */
        }
        
        /* Header inside content */
        header {
            position: sticky; /* Already sticky */
            top: 0; /* Stick to the top of the viewport */
            background-color: var(--primary-blue);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 110; /* Above sidebar */
            box-shadow: var(--box-shadow-light);
            transition: background-color 0.3s ease, box-shadow 0.3s ease; /* Smooth transition for dark mode */
        }

        header h1 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 700;
        }

        /* Header controls */
        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem; /* Space between buttons/dropdowns */
        }

        /* Navigation button styling (Logout, Dark Mode Toggle) */
        nav button {
            background-color: transparent;
            color: white;
            border: 1px solid white;
            padding: 0.75rem 1.5rem;
            border-radius: var(--button-radius);
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, border-color 0.3s ease;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        nav button i {
            margin-right: 8px;
        }

        nav button:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* Profile Dropdown */
        .profile-dropdown {
            position: relative;
            display: inline-block;
        }

        .profile-dropdown-btn {
            background-color: transparent;
            color: white;
            border: 1px solid white;
            padding: 0.75rem 1.2rem;
            border-radius: var(--button-radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.3s ease, transform 0.2s ease, border-color 0.3s ease;
            font-size: 1rem;
            font-weight: 600;
        }

        .profile-dropdown-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .profile-dropdown-content {
            display: none;
            position: absolute;
            background-color: var(--card-background);
            min-width: 160px;
            box-shadow: var(--box-shadow-light);
            z-index: 1;
            right: 0; /* Align to the right of the button */
            border-radius: var(--button-radius);
            overflow: hidden; /* For rounded corners */
            margin-top: 10px; /* Space from button */
        }

        .profile-dropdown-content a {
            color: var(--text-dark);
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            text-align: left;
            transition: background-color 0.2s ease;
        }

        .profile-dropdown-content a:hover {
            background-color: var(--background-light);
        }

        .profile-dropdown.open .profile-dropdown-content {
            display: block;
        }


        /* Add this to limit main content width on large screens and center it */
        .content-area main { /* Targeting the <main> element within .content-area */
            max-width: 1200px; /* Adjust as needed for desired content width */
            margin: 0 auto; /* Center the main content */
            padding: 2rem; /* Add padding here as content-area no longer has it */
        }

        /* Card component styling */
        .card {
            background-color: var(--card-background);
            border-radius: var(--border-radius); /* Applied from new variable */
            padding: 2.5rem;
            box-shadow: var(--box-shadow-light); /* Applied from new variable */
            margin-bottom: 2rem;
            transition: transform 0.2s ease, background-color 0.3s ease, box-shadow 0.3s ease; /* Smooth transition for dark mode and hover */
        }

        .card:hover {
            transform: translateY(-4px); /* Lift card on hover for interaction feedback */
        }

        /* Login card specific styling */
        .login-card {
            max-width: 450px;
            margin: 4rem auto; /* Center the login card vertically and horizontally */
            text-align: center;
            padding: 3rem;
            box-shadow: var(--box-shadow-light);
            border-radius: var(--border-radius);
            background-color: var(--card-background);
            transition: background-color 0.3s ease, box-shadow 0.3s ease; /* Dark mode transition */
        }

        .login-card h2 {
            color: var(--primary-blue);
            margin-bottom: 2rem;
            font-size: 2rem;
            font-weight: 700;
        }

        .login-card form {
            display: flex;
            flex-direction: column;
            gap: 1.25rem; /* Spacing between form elements */
        }

        /* Input and select field styling */
        .login-card input, 
        .login-card select,
        .card input[type="text"],
        .card input[type="email"],
        .card input[type="date"],
        .card input[type="number"],
        .card select,
        .card textarea,
        .card input[type="file"] {
            padding: 1rem;
            border: 1px solid var(--border-light);
            border-radius: var(--button-radius); /* Using button radius for consistency */
            font-size: 1rem;
            width: 100%; /* Full width */
            box-sizing: border-box; /* Include padding in width */
            transition: border-color 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease, color 0.3s ease;
            background-color: var(--card-background); /* Ensure consistent background */
            color: var(--text-dark);
        }

        .login-card input:focus, 
        .login-card select:focus,
        .card input:focus,
        .card select:focus,
        .card textarea:focus,
        .card input[type="file"]:focus {
            border-color: var(--primary-blue);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 86, 179, 0.2); /* Focus glow effect */
        }
        
        /* Button styling for forms and actions */
        button {
            border: none;
            border-radius: var(--button-radius);
            padding: 0.8rem 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease; /* Apply transition to all button properties */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px; /* Space between icon and text */
        }

        button.primary,
        .login-card button,
        .card button.main-action-btn,
        #attendance-controls button {
            background-color: var(--primary-blue);
            color: white;
        }

        button.primary:hover,
        .login-card button:hover,
        .card button.main-action-btn:hover,
        #attendance-controls button:hover {
            background-color: var(--button-hover-dark);
            transform: translateY(-2px);
        }

        /* Table specific button styles */
        td button.approve {
            background-color: var(--primary-blue);
            color: white;
        }
        td button.approve:hover {
            background-color: var(--button-hover-dark);
        }

        td button.reject, td button.delete {
            background-color: #dc3545; /* Red for reject/delete */
            color: white;
        }
        td button.reject:hover, td button.delete:hover {
            background-color: #c0392b;
        }

        td button.edit {
            background-color: #ffcc00; /* Yellow for edit */
            color: var(--text-dark); /* Dark text on yellow */
        }
        td button.edit:hover {
            background-color: var(--button-hover-yellow);
        }

        button:disabled {
            background-color: #cccccc !important;
            cursor: not-allowed;
            opacity: 0.7;
            transform: none !important;
        }

        /* Utility class to hide elements */
        .hidden {
            display: none !important;
        }

        /* Dashboard content specific styles */
        #main-dashboard-content h2.section-title {
            color: var(--text-dark);
            border-bottom: 2px solid var(--primary-blue);
            padding-bottom: 0.75rem;
            margin-bottom: 2rem;
            font-size: 2rem;
            font-weight: 700;
        }

        /* Grid for info cards */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); /* Responsive grid columns, slightly smaller min */
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        /* Info card styling */
        .info-card {
            background-color: var(--background-light); /* Slightly darker background for info cards */
            border-left: 6px solid var(--accent-yellow); /* Accent border */
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: background-color 0.3s ease, box-shadow 0.3s ease; /* Dark mode transition */
        }
        
        .info-card h3 {
            margin-top: 0;
            color: var(--primary-blue);
            font-size: 1.25rem;
            margin-bottom: 0.75rem;
        }

        .info-card p {
            margin-bottom: 0.5rem;
            font-size: 1rem;
            color: var(--text-light);
        }

        /* Section header styling */
        .section-header {
            margin-top: 3rem;
            margin-bottom: 1.5rem;
            font-size: 1.75rem;
            color: var(--text-dark);
            border-bottom: 1px solid var(--border-light);
            padding-bottom: 0.75rem;
            font-weight: 600;
        }

        /* Table container for overflow on small screens */
        .table-container {
            overflow-x: auto;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow-light);
            transition: box-shadow 0.3s ease; /* Dark mode transition */
        }

        /* Table styling */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background-color: var(--card-background); /* White background for tables */
            min-width: 600px; /* Ensure table is wide enough for content */
            border-radius: var(--border-radius); /* Apply rounded corners to table */
            overflow: hidden; /* Ensures rounded corners are visible */
            transition: background-color 0.3s ease, color 0.3s ease; /* Dark mode transition */
        }
        
        th, td {
            text-align: left;
            padding: 1.2rem 1rem;
            border-bottom: 1px solid var(--border-light);
            color: var(--text-dark);
            transition: color 0.3s ease, border-color 0.3s ease; /* Dark mode transition */
        }
        
        th {
            background-color: var(--background-light); /* Light grey background for table headers */
            font-weight: 700;
            color: var(--primary-blue);
            text-transform: uppercase;
            font-size: 0.9rem;
            position: sticky; /* Sticky header row */
            top: 0; /* Stick to the top of the table container */
            z-index: 50; /* Ensure header is above scrolling rows */
            transition: background-color 0.3s ease, color 0.3s ease; /* Dark mode transition */
        }

        tr:last-child td {
            border-bottom: none; /* No border for the last row */
        }

        tr:nth-child(even) { /* Striped rows */
            background-color: var(--background-light);
        }
        body.dark-mode tr:nth-child(even) { /* Dark mode striped rows */
            background-color: rgba(255, 255, 255, 0.05); /* Lighter dark for stripes */
        }

        tr:hover {
            background-color: #fafafa; /* Light hover effect */
        }
        body.dark-mode tr:hover {
            background-color: #2a2a2a; /* Dark mode hover effect */
        }
        
        /* Form section styling */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.95rem;
            transition: color 0.3s ease; /* Dark mode transition */
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--card-background);
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow-light);
            max-width: 600px; /* Wider modal for forms */
            width: 90%;
            /* Removed fixed height/max-height for content, let modal-body handle it */
            transform: translateY(-20px);
            transition: transform 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease; /* Dark mode transition */
            position: relative;
            display: flex; /* Flex container for title, scrollable body, and button */
            flex-direction: column; /* Stack children vertically */
        }

        .modal.visible .modal-content {
            transform: translateY(0);
        }
        
        .modal-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-light);
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .modal-close-btn:hover {
            color: var(--text-dark);
        }

        .modal-content h3 {
            margin-top: 0;
            color: var(--primary-blue);
            font-size: 1.5rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .modal-content p {
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
            color: var(--text-light);
            text-align: center;
        }

        /* New style for scrollable modal body */
        .modal-body-scrollable {
            max-height: 70vh; /* Adjust as needed, e.g., 70% of viewport height */
            overflow-y: auto; /* Enable vertical scrolling */
            padding-right: 15px; /* Space for scrollbar */
            margin-bottom: 1rem; /* Space before the submit button */
        }
        
        /* Chart container styling */
        .chart-container {
            background-color: var(--card-background);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow-light);
            margin-bottom: 2rem;
            transition: background-color 0.3s ease, box-shadow 0.3s ease; /* Dark mode transition */
        }
        .chart-container h3 {
            text-align: center;
            color: var(--primary-blue);
            margin-bottom: 1.5rem;
        }

        /* Notifications section */
        #notifications-section {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            padding: 1.5rem 2.5rem;
            box-shadow: var(--box-shadow-light);
            margin-bottom: 2rem;
            transition: background-color 0.3s ease, box-shadow 0.3s ease; /* Dark mode transition */
        }
        #notifications-section ul {
            list-style: none;
            padding: 0;
        }
        #notifications-section li {
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #notifications-section li:last-child {
            border-bottom: none;
        }
        #notifications-section .notification-time {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-left: auto;
        }


        /* Toggle button for sidebar on mobile */
        .sidebar-toggle {
            position: fixed;
            top: 1rem;
            left: 1rem;
            background-color: var(--primary-blue);
            color: white;
            border: none;
            border-radius: var(--button-radius);
            padding: 0.7rem 1rem;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 120; /* Above sidebar and content overlay */
            box-shadow: var(--box-shadow-light);
            display: none; /* Hidden on larger screens by default */
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        /* Responsive adjustments */
        @media (max-width: 992px) {
            /* No specific changes for 992px, desktop layout still applies */
        }

        @media (max-width: 768px) {
            body {
                flex-direction: column; /* Stack sidebar and content */
            }
            .sidebar {
                transform: translateX(-100%); /* Hide sidebar on small screens */
                position: fixed; /* Ensures it's off-canvas */
                height: 100vh;
                width: 250px; /* Fixed width for mobile sidebar */
            }
            .sidebar.visible {
                transform: translateX(0); /* Slide in when toggled */
            }
            .content-area {
                margin-left: 0; /* Content takes full width on mobile */
                /* Removed padding here */
            }
            .content-area main {
                padding: 1rem; /* Add padding to main content on mobile */
            }
            header {
                flex-direction: column;
                padding: 1rem;
                position: relative; /* Not sticky on mobile, follows flow */
                border-radius: var(--button-radius); /* Rounded header on mobile */
            }
            header h1 {
                margin-bottom: 1rem;
                font-size: 1.3rem;
            }
            .header-controls {
                flex-direction: column;
                width: 100%;
                gap: 0.5rem;
            }
            .header-controls button, .profile-dropdown-btn {
                width: 100%;
            }
            .profile-dropdown-content {
                left: 0; /* Align dropdown to left on mobile */
                width: 100%; /* Full width dropdown on mobile */
            }
            .login-card {
                margin: 2rem auto;
            }
            #main-dashboard-content h2.section-title {
                font-size: 1.5rem;
            }
            .section-header {
                font-size: 1.3rem;
            }
            .info-grid, .form-grid {
                grid-template-columns: 1fr;
            }
            th, td {
                padding: 0.8rem 0.6rem;
                font-size: 0.85rem;
            }
            td button {
                padding: 0.5rem 0.8rem;
                font-size: 0.8rem;
                margin-right: 0.3rem;
            }
            .sidebar-toggle {
                display: block; /* Show hamburger menu */
            }
            .content-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 105; /* Above content, below sidebar toggle */
                display: none;
            }
            .content-overlay.visible {
                display: block;
            }

            /* Responsive adjustments for modal-body-scrollable */
            .modal-body-scrollable {
                max-height: 60vh; /* Adjust max height for smaller screens */
            }
        }
    </style>
</head>
<body>

    <!-- Custom Message Modal -->
    <div id="message-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeMessageModal()"><i class="fas fa-times"></i></button>
            <h3 id="modal-title"></h3>
            <p id="modal-message"></p>
            <button id="modal-ok-btn" class="primary main-action-btn">OK</button>
        </div>
    </div>

    <!-- Employee Add/Edit Modal -->
    <div id="employee-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeEmployeeModal()"><i class="fas fa-times"></i></button>
            <h3 id="employee-modal-title">Add New Employee</h3>
            <div class="modal-body-scrollable"> <!-- New scrollable container -->
                <form id="employee-form">
                    <input type="hidden" id="employee-id-field"> <!-- Hidden field for employee ID in edit mode -->
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="modal-emp-name">Full Name</label>
                            <input type="text" id="modal-emp-name" placeholder="Employee Name" required>
                        </div>
                        <div class="form-group">
                            <label for="modal-emp-dob">Date of Birth</label>
                            <input type="date" id="modal-emp-dob" required>
                        </div>
                        <div class="form-group">
                            <label for="modal-emp-gender">Gender</label>
                            <select id="modal-emp-gender" required>
                                <option value="">Select Gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="modal-emp-contact">Contact (Phone/Email)</label>
                            <input type="text" id="modal-emp-contact" placeholder="+2547XXXXXXXX / email@example.com" required>
                        </div>
                        <div class="form-group">
                            <label for="modal-emp-id">National ID No</label>
                            <input type="text" id="modal-emp-id" placeholder="ID Number" required>
                        </div>
                        <div class="form-group">
                            <label for="modal-emp-kra">KRA PIN</label>
                            <input type="text" id="modal-emp-kra" placeholder="A123456789B" required>
                        </div>
                        <div class="form-group">
                            <label for="modal-emp-nhif">NHIF Number</label>
                            <input type="text" id="modal-emp-nhif" placeholder="NHIF Number" required>
                        </div>
                        <div class="form-group">
                            <label for="modal-emp-nssf">NSSF Number</label>
                            <input type="text" id="modal-emp-nssf" placeholder="NSSF Number" required>
                        </div>
                        <div class="form-group">
                            <label for="modal-emp-department">Department</label>
                            <input type="text" id="modal-emp-department" placeholder="e.g., HR, IT, Finance" required>
                        </div>
                        <div class="form-group">
                            <label for="modal-emp-designation">Designation</label>
                            <input type="text" id="modal-emp-designation" placeholder="e.g., Software Dev, Manager" required>
                        </div>
                        <div class="form-group">
                            <label for="modal-emp-hiredate">Hire Date</label>
                            <input type="date" id="modal-emp-hiredate" required>
                        </div>
                        <div class="form-group">
                            <label for="modal-emp-salary">Salary Scale (Ksh)</label>
                            <input type="number" id="modal-emp-salary" placeholder="e.g., 85000" required>
                        </div>
                        <div class="form-group">
                            <label for="modal-emp-status">Employee Status</label>
                            <select id="modal-emp-status" required>
                                <option value="Active">Active</option>
                                <option value="On Leave">On Leave</option>
                                <option value="Terminated">Terminated</option>
                                <option value="Suspended">Suspended</option>
                            </select>
                        </div>
                         <div class="form-group">
                            <label for="modal-emp-docs">Document Uploads (Simulated)</label>
                            <input type="file" id="modal-emp-docs" multiple>
                            <small>Contract, certificates, IDs</small>
                        </div>
                    </div>
                    <button type="submit" class="primary main-action-btn"><i class="fas fa-save"></i> Save Employee</button>
                </form>
            </div>
        </div>
    </div>


    <!-- Toggle button for sidebar on mobile -->
    <button class="sidebar-toggle hidden" id="sidebar-toggle-btn">
        <i class="fas fa-bars"></i>
    </button>
    <div class="content-overlay hidden" id="content-overlay"></div>


    <!-- Login Container - Visible by default -->
    <div class="login-card" id="login-container">
        <h2>Prince Alex HR & Payroll</h2>
        <form id="login-form">
            <select id="user-role" required>
                <option value="">Select Role</option>
                <option value="hr">HR Manager</option>
                <option value="employee">Employee</option>
            </select>
            <input type="text" id="username" placeholder="Username (optional for now)">
            <input type="password" id="password" placeholder="Password (optional for now)">
            <button type="submit" class="primary">Login</button>
        </form>
    </div>

    <!-- Main application layout - Hidden until login -->
    <div id="app-layout" class="hidden">
        <!-- Sidebar Navigation -->
        <div class="sidebar" id="sidebar">
            <h2><i class="fas fa-chart-line"></i> PA HR & Payroll</h2>
            <ul id="sidebar-nav-links">
                <!-- Links will be populated based on user role -->
            </ul>
        </div>

        <!-- Main Content Area -->
        <div class="content-area">
            <header id="main-header">
                <h1 id="header-title">Dashboard</h1>
                <div class="header-controls">
                    <!-- Dark Mode Toggle -->
                    <button id="dark-mode-toggle"><i class="fas fa-moon"></i> Dark Mode</button>
                    <!-- User Profile Dropdown -->
                    <div class="profile-dropdown" id="profile-dropdown">
                        <button class="profile-dropdown-btn" id="profile-dropdown-btn">
                            <i class="fas fa-user-circle"></i> <span id="header-user-name">User</span> <i class="fas fa-caret-down"></i>
                        </button>
                        <div class="profile-dropdown-content">
                            <a href="#" onclick="renderDashboardContent(currentUser.role, 'profile-section'); return false;"><i class="fas fa-id-badge"></i> My Profile</a>
                            <a href="#" onclick="showMessage('Settings Info', 'This section would allow user-specific settings.'); return false;"><i class="fas fa-cog"></i> Settings</a>
                        </div>
                    </div>
                    <button id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </div>
            </header>
            
            <main id="main-dashboard-content">
                <!-- Dashboard Content - Visible based on sidebar selection -->

                <!-- Dashboard Section -->
                <div id="dashboard-section" class="card content-section">
                    <h2 class="section-title">Dashboard Overview</h2>
                    <p>Welcome to your HR & Payroll Dashboard, <span id="current-user-name"></span>!</p>

                    <h3 class="section-header">Quick Insights</h3>
                    
                    <!-- Employee-specific Quick Insights -->
                    <div class="info-grid" id="employee-dashboard-insights">
                        <div class="info-card">
                            <h3>Leave Balance</h3>
                            <p><span id="emp-leave-balance">0</span> days left</p>
                        </div>
                        <div class="info-card">
                            <h3>Last Payslip</h3>
                            <p><span id="emp-last-payslip-month">-</span> - Ksh <span id="emp-last-payslip-net">0.00</span></p>
                        </div>
                        <div class="info-card">
                            <h3>Attendance (This Month)</h3>
                            <p><span id="emp-attendance-this-month">0</span> days present</p>
                        </div>
                        <div class="info-card">
                            <h3>Active Loans/Advances</h3>
                            <p>Ksh <span id="emp-active-loans">0.00</span></p>
                        </div>
                    </div>

                    <!-- HR/Admin Specific Quick Insights -->
                    <div class="info-grid hidden" id="hr-dashboard-insights">
                        <div class="info-card">
                            <h3>Total Employees</h3>
                            <p><span id="total-employees">0</span></p>
                        </div>
                        <div class="info-card">
                            <h3>Present Today</h3>
                            <p><span id="employees-present-today">0</span></p>
                        </div>
                        <div class="info-card">
                            <h3>Pending Leave Requests</h3>
                            <p><span id="pending-leave-requests">0</span></p>
                        </div>
                        <div class="info-card">
                            <h3>Total Payroll Cost (This Month)</h3>
                            <p>Ksh <span id="total-payroll-cost">0.00</span></p>
                        </div>
                    </div>

                    <h3 class="section-header">Notifications</h3>
                    <div id="notifications-section">
                        <ul id="notification-list">
                            <!-- Dynamic notifications will go here -->
                            <li><i class="fas fa-bell"></i> Mwangi Kimani requested Annual Leave. <span class="notification-time">5 mins ago</span></li>
                            <li><i class="fas fa-bell"></i> New Employee Akinyi Omondi added to HR. <span class="notification-time">1 hour ago</span></li>
                            <li><i class="fas fa-bell"></i> Monthly Payroll for August 2025 processed. <span class="notification-time">2 hours ago</span></li>
                            <li id="no-notifications" class="hidden"><i class="fas fa-info-circle"></i> No new notifications.</li>
                        </ul>
                    </div>


                    <h3 class="section-header">Analytics & Trends</h3>
                    <div class="info-grid">
                        <div class="chart-container">
                            <h3>Attendance Trend</h3>
                            <canvas id="attendance-chart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3>Payroll Expense Distribution</h3>
                            <canvas id="payroll-pie-chart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3>Leave Types Breakdown</h3>
                            <canvas id="leave-bar-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- My Profile Section (Employee) -->
                <div id="profile-section" class="card content-section hidden">
                    <h2 class="section-title">My Profile</h2>
                    <p>View and update your personal information and employment details.</p>

                    <h3 class="section-header">Personal Details</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Full Name:</label>
                            <input type="text" id="profile-name" readonly>
                        </div>
                        <div class="form-group">
                            <label>Date of Birth:</label>
                            <input type="date" id="profile-dob" readonly>
                        </div>
                        <div class="form-group">
                            <label>Gender:</label>
                            <input type="text" id="profile-gender" readonly>
                        </div>
                        <div class="form-group">
                            <label for="profile-contact">Contact (Phone/Email):</label>
                            <input type="text" id="profile-contact" class="editable-field">
                        </div>
                        <div class="form-group">
                            <label>National ID No:</label>
                            <input type="text" id="profile-national-id" readonly>
                        </div>
                        <div class="form-group">
                            <label>KRA PIN:</label>
                            <input type="text" id="profile-kra" readonly>
                        </div>
                        <div class="form-group">
                            <label>NHIF Number:</label>
                            <input type="text" id="profile-nhif" readonly>
                        </div>
                        <div class="form-group">
                            <label>NSSF Number:</label>
                            <input type="text" id="profile-nssf" readonly>
                        </div>
                    </div>
                    <button class="primary" onclick="saveProfileChanges()"><i class="fas fa-save"></i> Save Changes</button>
                    
                    <h3 class="section-header">Employment Details</h3>
                    <div class="form-grid">
                         <div class="form-group">
                            <label>Department:</label>
                            <input type="text" id="profile-department" readonly>
                        </div>
                        <div class="form-group">
                            <label>Designation:</label>
                            <input type="text" id="profile-designation" readonly>
                        </div>
                        <div class="form-group">
                            <label>Hire Date:</label>
                            <input type="date" id="profile-hire-date" readonly>
                        </div>
                        <div class="form-group">
                            <label>Contract Type:</label>
                            <input type="text" id="profile-contract-type" value="Permanent" readonly> <!-- Placeholder -->
                        </div>
                        <div class="form-group">
                            <label>Contract End Date:</label>
                            <input type="date" id="profile-contract-end" value="2030-12-31" readonly> <!-- Placeholder -->
                        </div>
                        <div class="form-group">
                            <label>Employment Status:</label>
                            <input type="text" id="profile-status" readonly>
                        </div>
                    </div>

                    <h3 class="section-header">Uploaded Documents (Simulated)</h3>
                    <ul>
                        <li><i class="fas fa-file-contract"></i> Employment Contract <button class="primary" onclick="showMessage('Document View', 'Simulating viewing of Employment Contract. (Would open a PDF viewer).')"><i class="fas fa-eye"></i> View</button></li>
                        <li><i class="fas fa-file-certificate"></i> Academic Certificates <button class="primary" onclick="showMessage('Document View', 'Simulating viewing of Academic Certificates.')"><i class="fas fa-eye"></i> View</button></li>
                        <li><i class="fas fa-id-card"></i> National ID Copy <button class="primary" onclick="showMessage('Document View', 'Simulating viewing of National ID Copy.')"><i class="fas fa-eye"></i> View</button></li>
                    </ul>
                </div>

                <!-- Employees Section (HR) -->
                <div id="employees-section" class="card content-section hidden">
                    <h2 class="section-title">Employee Management</h2>
                    <p>Add, view, edit, and manage employee profiles.</p>

                    <button class="primary" onclick="openEmployeeModal()"><i class="fas fa-user-plus"></i> Add New Employee</button>

                    <h3 class="section-header">Employee Directory</h3>
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label for="search-employee-name">Search by Name</label>
                            <input type="text" id="search-employee-name" placeholder="e.g., John Doe">
                        </div>
                        <div class="form-group">
                            <label for="filter-department">Filter by Department</label>
                            <input type="text" id="filter-department" placeholder="e.g., HR">
                        </div>
                        <div class="form-group">
                            <label for="filter-status">Filter by Status</label>
                            <select id="filter-status">
                                <option value="">All</option>
                                <option value="Active">Active</option>
                                <option value="On Leave">On Leave</option>
                                <option value="Terminated">Terminated</option>
                                <option value="Suspended">Suspended</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Department</th>
                                    <th>Designation</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="employees-table">
                                <!-- Employee data will be inserted here by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Attendance Section (HR/Employee) -->
                <div id="attendance-section" class="card content-section hidden">
                    <h2 class="section-title">Attendance Tracking</h2>
                    <p>Track daily check-ins and check-outs, lateness, and overtime.</p>

                    <h3 class="section-header">My Daily Attendance <span id="current-date-display"></span></h3>
                    <div class="info-grid">
                        <div class="info-card">
                            <h3>Today's Status</h3>
                            <p>Current: <span id="today-attendance-status">Not Checked In</span></p>
                            <p>Check-in Time: <span id="check-in-time-display">-</span></p>
                            <p>Check-out Time: <span id="check-out-time-display">-</p>
                            <div id="attendance-controls" style="margin-top: 15px;">
                                <button class="primary" onclick="checkIn()"><i class="fas fa-sign-in-alt"></i> Check In</button>
                                <button class="primary" onclick="checkOut()"><i class="fas fa-sign-out-alt"></i> Check Out</button>
                            </div>
                            <p style="margin-top: 10px; font-size: 0.9em; color: var(--text-light);"><i class="fas fa-info-circle"></i> Options: QR Code Scan, Biometric integration (future upgrades)</p>
                        </div>
                        <div class="info-card">
                            <h3>Overtime / Lateness (Today)</h3>
                            <p>Overtime Hours: <span id="overtime-hours">0 hrs</span></p>
                            <p>Lateness (Today): <span id="lateness-minutes">0 min</span></p>
                            <p style="font-size: 0.9em; color: var(--text-light);"><i class="fas fa-clock"></i> Standard Shift: 08:00 - 17:00</p>
                        </div>
                    </div>

                    <h3 class="section-header">Attendance History</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Check In</th>
                                    <th>Check Out</th>
                                    <th>Hours Worked</th>
                                    <th>Status</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody id="attendance-history-table">
                                <!-- Attendance data will be inserted here by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Leave Section (HR/Employee) -->
                <div id="leave-section" class="card content-section hidden">
                    <h2 class="section-title">Leave Management</h2>
                    <p>Apply for, approve, or reject various types of leave.</p>

                    <h3 class="section-header" id="leave-balances-title">My Leave Balances</h3>
                    <div class="info-grid" id="leave-balances-grid">
                        <!-- Leave balances will be inserted here by JS -->
                        <div class="info-card">
                            <h3>Annual Leave</h3>
                            <p><span id="annual-leave-balance">15</span> days remaining</p>
                        </div>
                        <div class="info-card">
                            <h3>Sick Leave</h3>
                            <p><span id="sick-leave-balance">7</span> days remaining</p>
                        </div>
                        <div class="info-card">
                            <h3>Maternity Leave</h3>
                            <p><span id="maternity-leave-balance">90</span> days remaining</p>
                        </div>
                    </div>

                    <h3 class="section-header" id="apply-leave-title">Apply for Leave</h3>
                    <form id="leave-request-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="leave-type">Leave Type:</label>
                                <select id="leave-type" required>
                                    <option value="">Select Leave Type</option>
                                    <option value="Annual">Annual</option>
                                    <option value="Sick">Sick</option>
                                    <option value="Maternity">Maternity</option>
                                    <option value="Compassionate">Compassionate</option>
                                    <option value="Study">Study</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="leave-start-date">Start Date:</label>
                                <input type="date" id="leave-start-date" required>
                            </div>
                            <div class="form-group">
                                <label for="leave-end-date">End Date:</label>
                                <input type="date" id="leave-end-date" required>
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label for="leave-reason">Reason:</label>
                                <textarea id="leave-reason" rows="3" placeholder="Briefly state your reason for leave" required></textarea>
                            </div>
                        </div>
                        <button type="submit" class="primary"><i class="fas fa-paper-plane"></i> Submit Leave Request</button>
                    </form>

                    <h3 class="section-header" id="leave-requests-title">Pending Leave Requests (HR View)</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Req. ID</th>
                                    <th>Employee</th>
                                    <th>Type</th>
                                    <th>Period</th>
                                    <th>Reason</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="leave-requests-table">
                                <!-- Leave requests for HR to approve/reject -->
                            </tbody>
                        </table>
                    </div>

                    <h3 class="section-header" id="my-leave-history-title">My Leave History (Employee View)</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Req. ID</th>
                                    <th>Type</th>
                                    <th>Period</th>
                                    <th>Reason</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="my-leave-history-table">
                                <!-- Employee's own leave history -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Payroll Section (HR) -->
                <div id="payroll-section" class="card content-section hidden">
                    <h2 class="section-title">Payroll Processing</h2>
                    <p>Calculate salaries, statutory deductions, generate payslips, and manage disbursements.</p>

                    <h3 class="section-header">Process Monthly Payroll</h3>
                    <div class="form-grid" style="grid-template-columns: 1fr;">
                        <div class="form-group">
                            <label for="payroll-month-input">Select Month for Payroll:</label>
                            <input type="month" id="payroll-month-input" value="2025-08" required>
                        </div>
                    </div>
                    <button id="process-payroll-btn" class="primary"><i class="fas fa-calculator"></i> Process Payroll</button>
                    <p id="payroll-status" style="margin-top: 1rem; color: var(--text-dark);"><i class="fas fa-info-circle"></i> Last processed: -</p>

                    <h3 class="section-header">Payslips & Disbursement</h3>
                    <div class="form-grid" style="grid-template-columns: 1fr; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label for="filter-payroll-month">Filter Payroll by Month:</label>
                            <input type="month" id="filter-payroll-month" placeholder="Select month">
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Month</th>
                                    <th>Employee</th>
                                    <th>Gross Pay</th>
                                    <th>Deductions</th>
                                    <th>Net Pay</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="payroll-summary-table">
                                <!-- Processed payroll data -->
                            </tbody>
                        </table>
                    </div>
                    <button class="primary" style="margin-top: 1rem;"><i class="fas fa-wallet"></i> Simulate M-Pesa Disbursement</button>
                    <p style="margin-top: 10px; font-size: 0.9em; color: var(--text-light);"><i class="fas fa-info-circle"></i> M-Pesa API & Bank Integration (future upgrades)</p>
                </div>

                <!-- Reports Section -->
                <div id="reports-section" class="card content-section hidden">
                    <h2 class="section-title">Reports & Analytics</h2>
                    <p>Access various HR, payroll, and leave reports for insights and compliance.</p>

                    <h3 class="section-header">HR Reports</h3>
                    <ul>
                        <li><i class="fas fa-file-alt"></i> Employee Headcount & Demographics (Simulated) <button class="primary" onclick="generateReport('employee-demographics')">Generate</button> <button class="primary" onclick="exportReport('employee-demographics', 'pdf')"><i class="fas fa-file-pdf"></i> PDF</button></li>
                        <li><i class="fas fa-file-alt"></i> Employee Turnover (Simulated) <button class="primary" onclick="generateReport('employee-turnover')">Generate</button> <button class="primary" onclick="exportReport('employee-turnover', 'excel')"><i class="fas fa-file-excel"></i> Excel</button></li>
                    </ul>

                    <h3 class="section-header">Payroll Reports</h3>
                    <ul>
                        <li><i class="fas fa-file-alt"></i> Monthly Payroll Summary (Simulated) <button class="primary" onclick="generateReport('monthly-payroll')">Generate</button> <button class="primary" onclick="exportReport('monthly-payroll', 'pdf')"><i class="fas fa-file-pdf"></i> PDF</button></li>
                        <li><i class="fas fa-file-alt"></i> Statutory Deductions (Simulated) <button class="primary" onclick="generateReport('statutory-deductions')">Generate</button> <button class="primary" onclick="exportReport('statutory-deductions', 'excel')"><i class="fas fa-file-excel"></i> Excel</button></li>
                    </ul>

                    <h3 class="section-header">Leave Reports</h3>
                    <ul>
                        <li><i class="fas fa-file-alt"></i> Leave Trends & Utilization (Simulated) <button class="primary" onclick="generateReport('leave-trends')">Generate</button> <button class="primary" onclick="exportReport('leave-trends', 'pdf')"><i class="fas fa-file-pdf"></i> PDF</button></li>
                        <li><i class="fas fa-file-alt"></i> Pending Leaves Overview (Simulated) <button class="primary" onclick="generateReport('pending-leaves')">Generate</button> <button class="primary" onclick="exportReport('pending-leaves', 'excel')"><i class="fas fa-file-excel"></i> Excel</button></li>
                    </ul>
                    <p style="margin-top: 1.5rem; font-size: 0.9em; color: var(--text-light);"><i class="fas fa-chart-line"></i> Graphs (e.g., Chart.js) would be integrated here for visual trends.</p>
                </div>

                <!-- Integrations Section -->
                <div id="integrations-section" class="card content-section hidden">
                    <h2 class="section-title">Integrations & Advanced Features</h2>
                    <p>Connect with external services for enhanced HR and payroll operations.</p>

                    <h3 class="section-header">Financial Integrations</h3>
                    <ul>
                        <li><i class="fas fa-mobile-alt"></i> M-Pesa API Integration for Salary Disbursements: <span style="color: green;">Active (Simulated)</span> <button class="primary">Configure</button></li>
                        <li><i class="fas fa-university"></i> Bank Integration for Bulk Transfers: <span style="color: orange;">Pending Setup</span> <button class="primary">Set Up</button></li>
                    </ul>

                    <h3 class="section-header">Communication & Compliance</h3>
                    <ul>
                        <li><i class="fas fa-comment-dots"></i> WhatsApp Bot for Payslips/Leave Requests: <span style="color: green;">Active (Simulated)</span> <button class="primary">Manage Bot</button></li>
                        <li><i class="fas fa-gavel"></i> KRA iTax API for Auto PAYE Filing: <span style="color: red;">Future Upgrade</span> <button class="primary" disabled>Enable</button></li>
                    </ul>

                    <h3 class="section-header">Data Management Strategy</h3>
                    <p>Current (Prototype): **LocalStorage** is used to simulate data persistence for the current browser session.</p>
                    <p>Next Stage (Upgrade): **Firebase (Auth, Firestore DB, Cloud Functions)** for scalable backend and authentication.</p>
                    <p>Enterprise Stage: **Supabase or custom backend (Postgres + API)** for advanced requirements.</p>
                </div>

            </main>
        </div>
    </div>

    <!-- Payslip Template - Hidden by default -->
    <div id="payslip-template" style="width: 700px; margin: 0 auto; padding: 30px; background: #fff; font-family: 'Inter', sans-serif; display: none; box-sizing: border-box; border: 1px solid #eee; box-shadow: 0 0 10px rgba(0,0,0,0.05);">
        <div style="text-align: center; margin-bottom: 25px; border-bottom: 2px solid #0056b3; padding-bottom: 15px;">
            <!-- Company Details -->
            <img src="https://placehold.co/150x50/0056b3/ffffff?text=Company+Logo" alt="Company Logo" style="max-width: 150px; margin-bottom: 10px;">
            <h1 style="color: #0056b3; margin: 0; font-size: 2.2em;">Prince Alex HR & Payroll</h1>
            <p style="margin: 5px 0 0; font-size: 0.9em; color: #555;">123 HR Street, Nairobi, Kenya | Phone: +254 7XX XXX XXX | Email: info@princealex.com</p>
        </div>

        <h2 style="text-align: center; color: #333; margin-bottom: 25px; font-size: 1.8em;">Payslip - <span id="payslip-month">July 2025</span></h2>

        <div style="display: flex; justify-content: space-between; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
            <!-- Employee Details -->
            <div style="width: 48%;">
                <p style="margin: 5px 0;"><strong style="color: #0056b3;">Employee Name:</strong> <span id="payslip-employee-name">John Doe</span></p>
                <p style="margin: 5px 0;"><strong style="color: #0056b3;">Employee ID:</strong> <span id="payslip-employee-id">EMP001</span></p>
                <p style="margin: 5px 0;"><strong style="color: #0056b3;">Department:</strong> <span id="payslip-department">Operations</span></p>
            </div>
            <div style="width: 48%; text-align: right;">
                <p style="margin: 5px 0;"><strong style="color: #0056b3;">Position:</strong> <span id="payslip-position">Customer Care</span></p>
                <p style="margin: 5px 0;"><strong style="color: #0056b3;">Payroll Number:</strong> <span id="payslip-payroll-number">PAY12345</span></p>
            </div>
        </div>

        <table style="width: 100%; border-collapse: collapse; margin-bottom: 25px;">
            <thead>
                <tr style="background-color: #f4f7fa;">
                    <th style="padding: 12px; border: 1px solid #ddd; text-align: left; color: #0056b3;">Earnings</th>
                    <th style="padding: 12px; border: 1px solid #ddd; text-align: right; color: #0056b3;">Amount (Ksh)</th>
                    <th style="padding: 12px; border: 1px solid #ddd; text-align: left; color: #dc3545;">Deductions</th>
                    <th style="padding: 12px; border: 1px solid #ddd; text-align: right; color: #dc3545;">Amount (Ksh)</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td style="padding: 10px; border: 1px solid #eee; text-align: left;">Basic Salary</td>
                    <td style="padding: 10px; border: 1px solid #eee; text-align: right;"><span id="payslip-basic-salary">40,000.00</span></td>
                    <td style="padding: 10px; border: 1px solid #eee; text-align: left;">PAYE</td>
                    <td style="padding: 10px; border: 1px solid #eee; text-align: right;"><span id="payslip-paye">3,500.00</span></td>
                </tr>
                <tr>
                    <td style="padding: 10px; border: 1px solid #eee; text-align: left;">House Allowance</td>
                    <td style="padding: 10px; border: 1px solid #eee; text-align: right;"><span id="payslip-house-allowance">5,000.00</span></td>
                    <td style="padding: 10px; border: 1px solid #eee; text-align: left;">NHIF</td>
                    <td style="padding: 10px; border: 1px solid #eee; text-align: right;"><span id="payslip-nhif">1,200.00</span></td>
                </tr>
                <tr>
                    <td style="padding: 10px; border: 1px solid #eee; text-align: left;">Transport Allowance</td>
                    <td style="padding: 10px; border: 1px solid #eee; text-align: right;"><span id="payslip-transport-allowance">3,000.00</span></td>
                    <td style="padding: 10px; border: 1px solid #eee; text-align: left;">NSSF</td>
                    <td style="padding: 10px; border: 1px solid #eee; text-align: right;"><span id="payslip-nssf">1,080.00</span></td>
                </tr>
                <tr>
                    <td style="padding: 10px; border: 1px solid #eee; text-align: left;">Medical Allowance</td>
                    <td style="padding: 10px; border: 1px solid #eee; text-align: right;"><span id="payslip-medical-allowance">2,000.00</span></td>
                    <td style="padding: 10px; border: 1px solid #eee; text-align: left;">Loan Repayment</td>
                    <td style="padding: 10px; border: 1px solid #eee; text-align: right;"><span id="payslip-loan">2,500.00</span></td>
                </tr>
                <tr>
                    <td style="padding: 10px; border: 1px solid #eee; text-align: left;">Overtime Pay</td>
                    <td style="padding: 10px; border: 1px solid #eee; text-align: right;"><span id="payslip-overtime">1,500.00</span></td>
                    <td style="padding: 10px; border: 1px solid #eee; text-align: left;">Other Deductions</td>
                    <td style="padding: 10px; border: 1px solid #eee; text-align: right;"><span id="payslip-other-deductions">0.00</span></td>
                </tr>
                <!-- Dynamic rows for additional earnings/deductions can be added here -->
            </tbody>
            <tfoot>
                <tr style="background-color: #e0e7ff; font-weight: bold;">
                    <td colspan="2" style="padding: 12px; border: 1px solid #ddd; text-align: left; color: #0056b3;">Gross Pay</td>
                    <td colspan="2" style="padding: 12px; border: 1px solid #ddd; text-align: right; color: #0056b3;"><span id="payslip-gross-pay">51,500.00</span></td>
                </tr>
                <tr style="background-color: #ffe0e0; font-weight: bold;">
                    <td colspan="2" style="padding: 12px; border: 1px solid #ddd; text-align: left; color: #dc3545;">Total Deductions</td>
                    <td colspan="2" style="padding: 12px; border: 1px solid #ddd; text-align: right; color: #dc3545;"><span id="payslip-total-deductions">8,280.00</span></td>
                </tr>
                <tr style="background-color: #ccffcc; font-weight: bold; font-size: 1.2em;">
                    <td colspan="2" style="padding: 15px 12px; border: 1px solid #ddd; text-align: left; color: #28a745;">NET PAY</td>
                    <td colspan="2" style="padding: 15px 12px; border: 1px solid #ddd; text-align: right; color: #28a745;"><span id="payslip-net-pay">43,220.00</span></td>
                </tr>
            </tfoot>
        </table>

        <div style="text-align: center; margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px; font-size: 0.85em; color: #777;">
            <p style="margin: 0;">_____________________________</p>
            <p style="margin: 5px 0 15px;">HR Manager Signature</p>
            <p style="margin: 0; font-style: italic;">"This is a system generated payslip â€“ no signature required."</p>
            <p style="margin: 15px 0 0;">&copy; Prince Alex HR & Payroll System</p>
        </div>
    </div>
    <!-- End Payslip Template -->

    <!-- html2pdf.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        // --- DOM Element References ---
        const loginForm = document.getElementById('login-form');
        const loginContainer = document.getElementById('login-container');
        const appLayout = document.getElementById('app-layout');
        const mainHeader = document.getElementById('main-header');
        const headerTitle = document.getElementById('header-title');
        const sidebar = document.getElementById('sidebar');
        const sidebarNavLinks = document.getElementById('sidebar-nav-links'); // New reference for dynamic sidebar
        const logoutBtn = document.getElementById('logout-btn');
        const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
        const contentOverlay = document.getElementById('content-overlay');
        const profileDropdown = document.getElementById('profile-dropdown');
        const profileDropdownBtn = document.getElementById('profile-dropdown-btn');
        const headerUserNameSpan = document.getElementById('header-user-name');
        const darkModeToggleBtn = document.getElementById('dark-mode-toggle');

        const mainDashboardContent = document.getElementById('main-dashboard-content');

        // Sections
        const dashboardSection = document.getElementById('dashboard-section');
        const employeesSection = document.getElementById('employees-section');
        const attendanceSection = document.getElementById('attendance-section');
        const leaveSection = document.getElementById('leave-section');
        const payrollSection = document.getElementById('payroll-section');
        const reportsSection = document.getElementById('reports-section');
        const integrationsSection = document.getElementById('integrations-section');
        const notificationsList = document.getElementById('notification-list');
        const noNotifications = document.getElementById('no-notifications');
        const profileSection = document.getElementById('profile-section'); // New profile section

        // Employee Dashboard Quick Insights
        const empLeaveBalanceSpan = document.getElementById('emp-leave-balance');
        const empLastPayslipMonthSpan = document.getElementById('emp-last-payslip-month');
        const empLastPayslipNetSpan = document.getElementById('emp-last-payslip-net');
        const empAttendanceThisMonthSpan = document.getElementById('emp-attendance-this-month');
        const empActiveLoansSpan = document.getElementById('emp-active-loans');
        const employeeDashboardInsights = document.getElementById('employee-dashboard-insights'); // New ID for employee insights grid


        // Admin/HR specific Dashboard Quick Insights (existing from previous version)
        const totalEmployeesSpan = document.getElementById('total-employees');
        const employeesPresentTodaySpan = document.getElementById('employees-present-today');
        const pendingLeaveRequestsSpan = document.getElementById('pending-leave-requests');
        const totalPayrollCostSpan = document.getElementById('total-payroll-cost');

        const currentUserNameSpan = document.getElementById('current-user-name');

        // Chart instances (global so we can update/destroy them)
        let attendanceChartInstance = null;
        let payrollPieChartInstance = null;
        let leaveBarChartInstance = null;

        // Attendance elements
        const currentCheckInTimeDisplay = document.getElementById('check-in-time-display');
        const currentCheckOutTimeDisplay = document.getElementById('check-out-time-display');
        const todayAttendanceStatusSpan = document.getElementById('today-attendance-status');
        const overtimeHoursSpan = document.getElementById('overtime-hours');
        const latenessMinutesSpan = document.getElementById('lateness-minutes');
        const attendanceHistoryTableBody = document.getElementById('attendance-history-table');
        const currentDateDisplay = document.getElementById('current-date-display');


        // Leave Management elements
        const annualLeaveBalanceSpan = document.getElementById('annual-leave-balance');
        const sickLeaveBalanceSpan = document.getElementById('sick-leave-balance');
        const maternityLeaveBalanceSpan = document.getElementById('maternity-leave-balance');
        const leaveRequestForm = document.getElementById('leave-request-form');
        const leaveRequestsTableBody = document.getElementById('leave-requests-table');
        const myLeaveHistoryTableBody = document.getElementById('my-leave-history-table');

        // Payroll elements
        const processPayrollBtn = document.getElementById('process-payroll-btn');
        const payrollStatus = document.getElementById('payroll-status');
        const payrollSummaryTableBody = document.getElementById('payroll-summary-table');
        const payrollMonthInput = document.getElementById('payroll-month-input');
        const filterPayrollMonthInput = document.getElementById('filter-payroll-month');

        // Profile Section elements
        const profileName = document.getElementById('profile-name');
        const profileDob = document.getElementById('profile-dob');
        const profileGender = document.getElementById('profile-gender');
        const profileContact = document.getElementById('profile-contact');
        const profileNationalId = document.getElementById('profile-national-id');
        const profileKra = document.getElementById('profile-kra');
        const profileNhif = document.getElementById('profile-nhif');
        const profileNssf = document.getElementById('profile-nssf');
        const profileDepartment = document.getElementById('profile-department');
        const profileDesignation = document.getElementById('profile-designation');
        const profileHireDate = document.getElementById('profile-hire-date');
        const profileStatus = document.getElementById('profile-status');


        // Admin/Employee Management elements (still needed for HR/Admin)
        const employeeModal = document.getElementById('employee-modal');
        const employeeModalTitle = document.getElementById('employee-modal-title');
        const employeeForm = document.getElementById('employee-form'); // This is the form inside the modal
        const employeeIdField = document.getElementById('employee-id-field');
        const employeesTableBody = document.getElementById('employees-table');
        const searchEmployeeNameInput = document.getElementById('search-employee-name');
        const filterDepartmentInput = document.getElementById('filter-department');
        const filterStatusSelect = document.getElementById('filter-status');


        // Modal elements (General message modal)
        const messageModal = document.getElementById('message-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalOkBtn = document.getElementById('modal-ok-btn');

        // Payslip template elements
        const payslipTemplate = document.getElementById('payslip-template');
        const payslipMonth = document.getElementById('payslip-month');
        const payslipEmployeeName = document.getElementById('payslip-employee-name');
        const payslipEmployeeId = document.getElementById('payslip-employee-id');
        const payslipDepartment = document.getElementById('payslip-department');
        const payslipPosition = document.getElementById('payslip-position');
        const payslipPayrollNumber = document.getElementById('payslip-payroll-number');
        const payslipBasicSalary = document.getElementById('payslip-basic-salary');
        const payslipHouseAllowance = document.getElementById('payslip-house-allowance');
        const payslipTransportAllowance = document.getElementById('payslip-transport-allowance');
        const payslipMedicalAllowance = document.getElementById('payslip-medical-allowance');
        const payslipOvertime = document.getElementById('payslip-overtime');
        const payslipPaye = document.getElementById('payslip-paye');
        const payslipNhif = document.getElementById('payslip-nhif');
        const payslipNssf = document.getElementById('payslip-nssf');
        const payslipLoan = document.getElementById('payslip-loan');
        const payslipOtherDeductions = document.getElementById('payslip-other-deductions');
        const payslipGrossPay = document.getElementById('payslip-gross-pay');
        const payslipTotalDeductions = document.getElementById('payslip-total-deductions');
        const payslipNetPay = document.getElementById('payslip-net-pay');



        // --- Data Management (LocalStorage for Prototype Stage) ---
        // Function to load data from LocalStorage
        function loadData(key, defaultValue) {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : defaultValue;
        }

        // Function to save data to LocalStorage
        function saveData(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }

        let currentUser = null; // Stores the currently logged-in user's role and username

        // Initialize dummy data, loading from LocalStorage or using defaults
        let employees = loadData('employees', [
            { id: 'EMP001', name: 'Akinyi Omondi', dob: '1988-03-10', gender: 'Female', contact: '+254722112233', nationalId: '98765432', kraPin: 'A112233445C', nhif: '8765432', nssf: '3456789', department: 'HR', designation: 'HR Manager', hireDate: '2019-06-15', salary: 130000, status: 'Active' },
            { id: 'EMP002', name: 'Mwangi Kimani', dob: '1992-07-25', gender: 'Male', contact: 'mwangi.kimani@example.com', nationalId: '12345679', kraPin: 'B998877665D', nhif: '7654322', nssf: '1234568', department: 'IT', designation: 'Senior Software Dev', hireDate: '2020-09-01', salary: 95000, status: 'Active' },
            { id: 'EMP003', name: 'Fatuma Hassan', dob: '1985-01-01', gender: 'Female', contact: '+254733445566', nationalId: '23456780', kraPin: 'C112233446E', nhif: '6543211', nssf: '2345670', department: 'Finance', designation: 'Lead Accountant', hireDate: '2018-02-20', salary: 110000, status: 'On Leave' },
            { id: 'EMP004', name: 'James Otieno', dob: '1995-12-05', gender: 'Male', contact: 'james.otieno@example.com', nationalId: '34567891', kraPin: 'D554433227F', nhif: '5432109', nssf: '4567890', department: 'Marketing', designation: 'Marketing Specialist', hireDate: '2022-01-10', salary: 70000, status: 'Active' },
            { id: 'EMP005', name: 'Elizabeth Wanjiru', dob: '1990-04-20', gender: 'Female', contact: '+254701234567', nationalId: '45678902', kraPin: 'E667788990G', nhif: '4321098', nssf: '5678901', department: 'Operations', designation: 'Operations Coordinator', hireDate: '2021-05-01', salary: 80000, status: 'Active' },
            { id: 'EMP006', name: 'David Kipchoge', dob: '1986-09-12', gender: 'Male', contact: 'david.kipchoge@example.com', nationalId: '56789013', kraPin: 'F123456789H', nhif: '3210987', nssf: '6789012', department: 'Sales', designation: 'Sales Executive', hireDate: '2023-03-15', salary: 65000, status: 'Active' }
        ]);

        let leaveRequests = loadData('leaveRequests', [
            { reqId: 'LR001', empId: 'EMP002', employeeName: 'Mwangi Kimani', type: 'Annual', startDate: '2025-09-01', endDate: '2025-09-05', reason: 'Vacation', status: 'Pending' },
            { reqId: 'LR002', empId: 'EMP003', employeeName: 'Fatuma Hassan', type: 'Sick', startDate: '2025-08-20', endDate: '2025-08-22', reason: 'Fever', status: 'Approved' }
        ]);

        let payslips = loadData('payslips', [
            { month: 'July 2025', empId: 'EMP002', employeeName: 'Mwangi Kimani', grossPay: 95000, nhif: 1700, nssf: 1080, paye: 18000, otherDeductions: 5000, netPay: 69220, basicSalary: 76000, houseAllowance: 9500, transportAllowance: 4750, medicalAllowance: 4750, overtimePay: 2000, loanRepayment: 1000 },
            { month: 'June 2025', empId: 'EMP002', employeeName: 'Mwangi Kimani', grossPay: 95000, nhif: 1700, nssf: 1080, paye: 18000, otherDeductions: 5000, netPay: 69220, basicSalary: 76000, houseAllowance: 9500, transportAllowance: 4750, medicalAllowance: 4750, overtimePay: 2000, loanRepayment: 1000 }
        ]);

        let attendanceRecords = loadData('attendanceRecords', [
            { date: '2025-08-21', empId: 'EMP002', checkIn: '08:00', checkOut: '17:00', hours: 9, status: 'Present', lateness: 0, overtime: 0 },
            { date: '2025-08-20', empId: 'EMP002', checkIn: '08:30', checkOut: '17:30', hours: 9, status: 'Present', lateness: 30, overtime: 0 },
            { date: '2025-08-19', empId: 'EMP002', checkIn: '07:50', checkOut: '16:50', hours: 9, status: 'Present', lateness: 0, overtime: 0 }
        ]);

        let notifications = loadData('notifications', [
            { id: 'N001', message: 'Mwangi Kimani requested Annual Leave.', time: '5 mins ago', type: 'leave', read: false },
            { id: 'N002', message: 'New Employee Akinyi Omondi added to HR.', time: '1 hour ago', type: 'employee', read: false },
            { id: 'N003', message: 'Monthly Payroll for August 2025 processed.', time: '2 hours ago', type: 'payroll', read: false }
        ]);

        let employeeLoans = loadData('employeeLoans', [
            { empId: 'EMP002', amount: 15000, repaid: 5000, status: 'Active' },
            { empId: 'EMP001', amount: 20000, repaid: 20000, status: 'Completed' }
        ]);


        // Stores current day's attendance status in memory, not persisted by design
        let currentEmployeeAttendanceStatus = {
            'EMP002': { checkedIn: false, checkInTime: null, checkedOut: false, checkOutTime: null, date: null }
        };

        // --- Utility Functions ---

        /**
         * Generates a unique ID for new records.
         * @param {string} prefix - The prefix for the ID (e.g., 'EMP', 'LR').
         * @returns {string} A unique ID.
         */
        function generateUniqueId(prefix) {
            return prefix + Math.random().toString(36).substr(2, 9).toUpperCase();
        }

        /**
         * Adds a new notification to the list and updates display.
         * @param {string} message - The notification message.
         * @param {string} type - The type of notification (e.g., 'leave', 'employee', 'payroll').
         */
        function addNotification(message, type) {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const newNotification = {
                id: generateUniqueId('N'),
                message: message,
                time: timeString,
                type: type,
                read: false
            };
            notifications.unshift(newNotification); // Add to the beginning
            saveData('notifications', notifications);
            renderNotifications();
        }

        /**
         * Renders the notification list on the dashboard.
         */
        function renderNotifications() {
            notificationsList.innerHTML = ''; // Clear existing
            const unreadNotifications = notifications.filter(n => !n.read);

            if (unreadNotifications.length === 0) {
                noNotifications.classList.remove('hidden');
            } else {
                noNotifications.classList.add('hidden');
                unreadNotifications.slice(0, 5).forEach(n => { // Show up to 5 unread notifications
                    const li = document.createElement('li');
                    let iconClass = 'fas fa-bell';
                    if (n.type === 'leave') iconClass = 'fas fa-calendar-alt';
                    else if (n.type === 'employee') iconClass = 'fas fa-user-plus';
                    else if (n.type === 'payroll') iconClass = 'fas fa-money-check-alt';

                    li.innerHTML = `<i class="${iconClass}"></i> ${n.message} <span class="notification-time">${n.time}</span>`;
                    notificationsList.appendChild(li);
                });
            }
        }


        /**
         * Shows a custom modal message instead of `alert()`.
         * @param {string} title - The title of the modal.
         * @param {string} message - The message content.
         * @param {function} [callback] - Optional callback function to execute when OK is clicked.
         */
        function showMessage(title, message, callback) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            messageModal.classList.add('visible');

            const handleOk = () => {
                messageModal.classList.remove('visible');
                modalOkBtn.removeEventListener('click', handleOk);
                if (callback) {
                    callback();
                }
            };
            modalOkBtn.addEventListener('click', handleOk);
        }

        /**
         * Closes the general message modal.
         */
        function closeMessageModal() {
            messageModal.classList.remove('visible');
        }

        /**
         * Hides all dashboard content sections.
         */
        function hideAllContentSections() {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('hidden');
            });
        }

        /**
         * Destroys existing Chart.js instances to prevent memory leaks and conflicts.
         */
        function destroyCharts() {
            if (attendanceChartInstance) {
                attendanceChartInstance.destroy();
                attendanceChartInstance = null;
            }
            if (payrollPieChartInstance) {
                payrollPieChartInstance.destroy();
                payrollPieChartInstance = null;
            }
            if (leaveBarChartInstance) {
                leaveBarChartInstance.destroy();
                leaveBarChartInstance = null;
            }
        }

        /**
         * Populates sidebar navigation links based on user role.
         * @param {string} role - The role of the current user.
         */
        function populateSidebar(role) {
            sidebarNavLinks.innerHTML = ''; // Clear existing links
            let links = [];

            if (role === 'employee') {
                links = [
                    { target: 'dashboard', icon: 'fas fa-tachometer-alt', text: 'Dashboard' },
                    { target: 'profile', icon: 'fas fa-id-badge', text: 'My Profile' },
                    { target: 'payroll', icon: 'fas fa-money-check-alt', text: 'My Payslips' },
                    { target: 'attendance', icon: 'fas fa-calendar-check', text: 'Attendance' },
                    { target: 'leave', icon: 'fas fa-calendar-alt', text: 'Leave Requests' },
                    { target: 'notifications', icon: 'fas fa-bell', text: 'Notifications' }
                ];
            } else if (role === 'hr') { // hr
                links = [
                    { target: 'dashboard', icon: 'fas fa-tachometer-alt', text: 'Dashboard' },
                    { target: 'employees', icon: 'fas fa-users', text: 'Employees' },
                    { target: 'attendance', icon: 'fas fa-calendar-check', text: 'Attendance' },
                    { target: 'leave', icon: 'fas fa-calendar-alt', text: 'Leave' },
                    { target: 'payroll', icon: 'fas fa-money-check-alt', text: 'Payroll' },
                    { target: 'reports', icon: 'fas fa-chart-pie', text: 'Reports' },
                    { target: 'integrations', icon: 'fas fa-cogs', text: 'Integrations' }
                ];
            }

            links.forEach(link => {
                const listItem = document.createElement('li');
                const anchor = document.createElement('a');
                anchor.href = '#';
                anchor.dataset.target = link.target;
                anchor.innerHTML = `<i class="${link.icon}"></i> ${link.text}`;
                listItem.appendChild(anchor);
                sidebarNavLinks.appendChild(listItem);

                anchor.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = e.currentTarget.dataset.target + '-section';
                    renderDashboardContent(currentUser.role, targetId);
                });
            });
        }


        /**
         * Renders the appropriate dashboard based on the logged-in user's role and selected section.
         * @param {string} role - The role of the current user.
         * @param {string} sectionId - The ID of the content section to display (e.g., 'dashboard-section', 'employees-section').
         */
        function renderDashboardContent(role, sectionId) {
            hideAllContentSections();
            document.querySelectorAll('.sidebar ul li a').forEach(link => {
                link.classList.remove('active');
            });

            // Close profile dropdown when navigating
            profileDropdown.classList.remove('open');

            // Destroy charts before rendering new section, especially if not dashboard
            destroyCharts();

            // Show selected section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.remove('hidden');
                // Set active class on sidebar link
                const sidebarLink = document.querySelector(`.sidebar ul li a[data-target="${sectionId.replace('-section', '')}"]`);
                if (sidebarLink) {
                    sidebarLink.classList.add('active');
                }
            }

            // Update header title dynamically
            const cleanTitle = sectionId.replace('-section', '').split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
            headerTitle.textContent = cleanTitle;

            // Update user name in header and dashboard welcome
            const displayUserName = currentUser.username.charAt(0).toUpperCase() + currentUser.username.slice(1);
            currentUserNameSpan.textContent = ` ${displayUserName}`;
            headerUserNameSpan.textContent = displayUserName;


            // --- Role-specific visibility and data population ---

            // First, hide all elements that might be role-specific to reset state
            document.querySelector('#employees-section .primary')?.classList.add('hidden'); // Add Employee button
            document.getElementById('leave-requests-title').classList.add('hidden');
            document.getElementById('leave-requests-table')?.closest('.table-container')?.classList.add('hidden');
            document.getElementById('payroll-section').classList.add('hidden'); // Entire payroll section hidden by default
            document.getElementById('reports-section').classList.add('hidden');
            document.getElementById('integrations-section').classList.add('hidden');

            // Hide both insight grids by default
            document.getElementById('employee-dashboard-insights').classList.add('hidden');
            document.getElementById('hr-dashboard-insights').classList.add('hidden');
            
            // Hide dashboard charts section by default
            document.getElementById('dashboard-section').querySelector('h3.section-header:last-of-type').classList.add('hidden');
            document.getElementById('dashboard-section').querySelector('.info-grid:last-of-type').classList.add('hidden');


            // Leave section specific toggles
            document.getElementById('leave-balances-grid').classList.remove('hidden'); // Default to showing employee balances
            document.getElementById('apply-leave-title').classList.remove('hidden');
            document.getElementById('leave-request-form').classList.remove('hidden');
            document.getElementById('my-leave-history-title').classList.remove('hidden');
            document.getElementById('my-leave-history-table')?.closest('.table-container').classList.remove('hidden');
            document.getElementById('leave-balances-title').textContent = 'My Leave Balances';
            document.getElementById('apply-leave-title').textContent = 'Apply for Leave';


            switch (role) {
                case 'hr': // Combined logic for HR, as 'admin' is removed
                    document.querySelector('#employees-section .primary').classList.remove('hidden'); // Show Add Employee button
                    document.getElementById('employees-section').classList.remove('hidden');
                    document.getElementById('payroll-section').classList.remove('hidden'); // HR can see payroll
                    document.getElementById('reports-section').classList.remove('hidden'); // HR can see reports
                    document.getElementById('integrations-section').classList.remove('hidden'); // HR/Admin can see integrations
                    document.getElementById('notifications-section').classList.remove('hidden'); // HR/Admin see all notifications

                    // Show HR/Admin specific dashboard insights and charts
                    if (sectionId === 'dashboard-section') {
                        document.getElementById('hr-dashboard-insights').classList.remove('hidden'); // Show HR insights
                        updateDashboardInsights(); // Populate with data
                        document.getElementById('dashboard-section').querySelector('h3.section-header:last-of-type').classList.remove('hidden'); // Show Analytics & Trends header
                        document.getElementById('dashboard-section').querySelector('.info-grid:last-of-type').classList.remove('hidden'); // Show Charts grid
                        renderCharts(); // Render charts for HR/Admin dashboard
                    }
                    
                    // Show HR specific leave sections
                    document.getElementById('leave-requests-title').classList.remove('hidden');
                    document.getElementById('leave-requests-table').closest('.table-container').classList.remove('hidden');
                    
                    if (sectionId === 'employees-section') {
                        populateEmployeeTable();
                    } else if (sectionId === 'leave-section') {
                        populateHRLeaveTable();
                    } else if (sectionId === 'payroll-section') {
                        // Ensure payroll processing UI is visible for HR/Admin
                        document.getElementById('payroll-section').querySelector('.section-title').textContent = 'Payroll Processing';
                        document.getElementById('process-payroll-btn').classList.remove('hidden');
                        document.getElementById('payroll-status').classList.remove('hidden');
                        document.getElementById('payroll-section').querySelector('h3.section-header').classList.remove('hidden'); // Show "Process Monthly Payroll" header
                        document.getElementById('payroll-month-input').closest('.form-grid').classList.remove('hidden'); // Show month input for processing

                        populatePayrollSummaryTable();
                        payrollStatus.textContent = `Last processed: ${loadData('lastProcessedPayrollMonth', 'Never')}`;
                    } else if (sectionId === 'attendance-section') {
                        // HR/Admin would see an overview of all employee attendance, here we show Jane Smith's data as example for prototype
                        populateAttendanceHistoryTable('EMP002');
                    } else if (sectionId === 'notifications-section') {
                        renderNotifications(); // Ensure notifications are rendered
                    }

                    // Hide employee-specific leave forms as HR manages all
                    document.getElementById('leave-balances-grid').classList.add('hidden');
                    document.getElementById('apply-leave-title').classList.add('hidden');
                    document.getElementById('leave-request-form').classList.add('hidden');
                    document.getElementById('my-leave-history-title').classList.add('hidden');
                    document.getElementById('my-leave-history-table').closest('.table-container').classList.add('hidden');

                    document.getElementById('leave-balances-title').textContent = 'All Leave Balances'; // HR/Admin sees all
                    document.getElementById('apply-leave-title').textContent = 'Manage Leave Requests'; // HR/Admin manages
                    break;

                case 'employee':
                    // Explicitly hide HR/Admin specific sections
                    document.getElementById('employees-section').classList.add('hidden');
                    document.getElementById('payroll-section').classList.add('hidden'); // Only show employee payslips view, not processing
                    document.getElementById('reports-section').classList.add('hidden');
                    document.getElementById('integrations-section').classList.add('hidden');

                    // Show employee-specific dashboard insights
                    if (sectionId === 'dashboard-section') {
                         document.getElementById('employee-dashboard-insights').classList.remove('hidden'); // Show employee insights
                         updateEmployeeDashboardInsights(currentUser.empId); // Populate employee dashboard cards
                    } else if (sectionId === 'notifications-section') {
                        document.getElementById('notifications-section').classList.remove('hidden');
                        renderNotifications(); // Ensure notifications are rendered for employee
                    } else if (sectionId === 'attendance-section') {
                        updateCurrentAttendanceStatus(currentUser.empId);
                        populateAttendanceHistoryTable(currentUser.empId);
                        const today = new Date();
                        currentDateDisplay.textContent = ` - ${today.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
                    } else if (sectionId === 'leave-section') {
                        populateEmployeeLeaveBalances(currentUser.empId);
                        populateMyLeaveHistoryTable(currentUser.empId);
                    } else if (sectionId === 'payroll-section') { // This is "My Payslips" for employee
                        document.getElementById('payroll-section').classList.remove('hidden'); // Show it now for employee
                        document.getElementById('payroll-section').querySelector('.section-title').textContent = 'My Payslips';
                        document.getElementById('process-payroll-btn').classList.add('hidden'); // Hide process button
                        document.getElementById('payroll-status').classList.add('hidden'); // Hide payroll status
                        document.getElementById('payroll-section').querySelector('h3.section-header').classList.add('hidden'); // Hide "Process Monthly Payroll" header
                        document.getElementById('payroll-month-input').closest('.form-grid').classList.add('hidden'); // Hide month input for processing

                        populatePayrollSummaryTable(currentUser.empId);
                    } else if (sectionId === 'profile-section') {
                        populateEmployeeProfile(currentUser.empId);
                    }
                    break;
            }

            // Always ensure sidebar is hidden on mobile after navigation
            if (window.innerWidth <= 768) {
                sidebar.classList.remove('visible');
                contentOverlay.classList.add('hidden');
            }
        }

        // --- Employee-specific Dashboard Insights ---
        function updateEmployeeDashboardInsights(empId) {
            const employee = employees.find(e => e.id === empId);
            if (!employee) return;

            // Leave Balance
            empLeaveBalanceSpan.textContent = '15'; // Hardcoded for now, would fetch from leave data

            // Last Payslip
            const latestPayslip = payslips
                .filter(ps => ps.empId === empId)
                .sort((a, b) => new Date(b.month) - new Date(a.month))[0];
            if (latestPayslip) {
                empLastPayslipMonthSpan.textContent = latestPayslip.month;
                empLastPayslipNetSpan.textContent = latestPayslip.netPay.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            } else {
                empLastPayslipMonthSpan.textContent = 'N/A';
                empLastPayslipNetSpan.textContent = '0.00';
            }

            // Attendance This Month
            const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
            const daysPresentThisMonth = attendanceRecords.filter(rec => 
                rec.empId === empId && rec.date.startsWith(currentMonth) && rec.status === 'Present'
            ).length;
            empAttendanceThisMonthSpan.textContent = daysPresentThisMonth;

            // Active Loans/Advances
            const totalActiveLoans = employeeLoans
                .filter(loan => loan.empId === empId && loan.status === 'Active')
                .reduce((sum, loan) => sum + (loan.amount - loan.repaid), 0);
            empActiveLoansSpan.textContent = totalActiveLoans.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }


        // --- Dashboard Analytics Functions (HR/Admin focused for now) ---

        /**
         * Updates the quick insight cards on the dashboard.
         */
        function updateDashboardInsights() {
            // These are for HR general overview
            totalEmployeesSpan.textContent = employees.length;

            const today = new Date().toISOString().slice(0, 10);
            const presentToday = attendanceRecords.filter(rec => rec.date === today && rec.status === 'Present').length;
            employeesPresentTodaySpan.textContent = presentToday;

            const pendingLeaves = leaveRequests.filter(req => req.status === 'Pending').length;
            pendingLeaveRequestsSpan.textContent = pendingLeaves;

            const currentMonthYear = new Date().toLocaleString('en-US', { month: 'long', year: 'numeric' });
            const totalPayrollThisMonth = payslips
                                            .filter(ps => ps.month === currentMonthYear)
                                            .reduce((sum, ps) => ps.netPay, 0); // Sum of net pays for the month
            totalPayrollCostSpan.textContent = totalPayrollThisMonth.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        /**
         * Renders all Chart.js charts on the dashboard.
         */
        function renderCharts() {
            destroyCharts(); // Destroy any existing charts before rendering new ones

            // Define chart colors for consistency with branding
            const chartColors = [
                '#0056b3', // Primary blue
                '#ffcc00', // Accent yellow
                '#28a745', // Green
                '#dc3545', // Red
                '#6c757d', // Grey
                '#17a2b8'  // Info blue
            ];

            // Get current text color for chart labels (supports dark mode)
            const textColor = getComputedStyle(document.body).getPropertyValue('--text-dark').trim();


            // Attendance Trend (Line Chart)
            const attendanceCtx = document.getElementById('attendance-chart').getContext('2d');
            const attendanceDates = [...new Set(attendanceRecords.map(rec => rec.date))].sort().slice(-7); // Last 7 days
            const attendanceData = attendanceDates.map(date => attendanceRecords.filter(rec => rec.date === date && rec.status === 'Present').length);
            
            attendanceChartInstance = new Chart(attendanceCtx, {
                type: 'line',
                data: {
                    labels: attendanceDates,
                    datasets: [{
                        label: 'Employees Present',
                        data: attendanceData,
                        borderColor: chartColors[0],
                        backgroundColor: 'rgba(0, 86, 179, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            ticks: { precision: 0, color: textColor } 
                        },
                        x: {
                            ticks: { color: textColor }
                        }
                    },
                    plugins: {
                        title: { display: false },
                        legend: { 
                            display: true, 
                            position: 'bottom',
                            labels: { color: textColor }
                        }
                    }
                }
            });

            // Payroll Expense Distribution (Pie Chart)
            const payrollPieCtx = document.getElementById('payroll-pie-chart').getContext('2d');
            const payrollDeductionTypes = ['NHIF', 'NSSF', 'PAYE', 'Other Deductions'];
            const currentMonthYear = new Date().toLocaleString('en-US', { month: 'long', year: 'numeric' });
            const currentMonthPayslips = payslips.filter(ps => ps.month === currentMonthYear);
            
            let nhifTotal = currentMonthPayslips.reduce((sum, ps) => sum + (ps.nhif || 0), 0);
            let nssfTotal = currentMonthPayslips.reduce((sum, ps) => sum + (ps.nssf || 0), 0);
            let payeTotal = currentMonthPayslips.reduce((sum, ps) => sum + (ps.paye || 0), 0);
            let otherDeductionsTotal = currentMonthPayslips.reduce((sum, ps) => sum + (ps.otherDeductions || 0), 0);

            let payrollPieData = [nhifTotal, nssfTotal, payeTotal, otherDeductionsTotal];

            payrollPieChartInstance = new Chart(payrollPieCtx, {
                type: 'pie',
                data: {
                    labels: payrollDeductionTypes,
                    datasets: [{
                        data: payrollPieData,
                        backgroundColor: [chartColors[0], chartColors[1], chartColors[2], chartColors[3]],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: false },
                        legend: { 
                            display: true, 
                            position: 'bottom',
                            labels: { color: textColor }
                        }
                    }
                }
            });

            // Leave Types Breakdown (Bar Chart)
            const leaveBarCtx = document.getElementById('leave-bar-chart').getContext('2d');
            const leaveTypeCounts = leaveRequests.reduce((acc, req) => {
                acc[req.type] = (acc[req.type] || 0) + 1;
                return acc;
            }, {});
            const leaveLabels = Object.keys(leaveTypeCounts);
            const leaveData = Object.values(leaveTypeCounts);

            leaveBarChartInstance = new Chart(leaveBarCtx, {
                type: 'bar',
                data: {
                    labels: leaveLabels,
                    datasets: [{
                        label: 'Number of Requests',
                        data: leaveData,
                        backgroundColor: chartColors.slice(0, leaveLabels.length),
                        borderColor: chartColors.slice(0, leaveLabels.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            ticks: { precision: 0, color: textColor } 
                        },
                        x: {
                            ticks: { color: textColor }
                        }
                    },
                    plugins: {
                        title: { display: false },
                        legend: { display: false }
                    }
                }
            });
        }


        // --- HR Specific Functions (and shared Employee Table) ---

        /**
         * Populates the employee table in the Employees section.
         * Applies filters if provided.
         */
        function populateEmployeeTable() {
            employeesTableBody.innerHTML = ''; // Clear existing data
            const searchName = searchEmployeeNameInput.value.toLowerCase();
            const filterDept = filterDepartmentInput.value.toLowerCase();
            const filterStat = filterStatusSelect.value.toLowerCase();

            const filteredEmployees = employees.filter(emp => {
                const matchesName = searchName === '' || emp.name.toLowerCase().includes(searchName);
                const matchesDept = filterDept === '' || emp.department.toLowerCase().includes(filterDept);
                const matchesStatus = filterStat === '' || emp.status.toLowerCase() === filterStat;
                return matchesName && matchesDept && matchesStatus;
            });

            if (filteredEmployees.length === 0) {
                employeesTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No employees found matching criteria.</td></tr>';
                return;
            }

            filteredEmployees.forEach(emp => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${emp.id}</td>
                    <td>${emp.name}</td>
                    <td>${emp.department}</td>
                    <td>${emp.designation}</td>
                    <td><span style="color: ${emp.status === 'Active' ? 'green' : (emp.status === 'On Leave' ? 'orange' : (emp.status === 'Terminated' ? 'red' : 'gray'))}">${emp.status}</span></td>
                    <td>
                        <button class="edit" onclick="openEmployeeModal('${emp.id}')"><i class="fas fa-edit"></i> Edit</button>
                        <button class="delete" onclick="deleteEmployee('${emp.id}')"><i class="fas fa-trash"></i> Delete</button>
                    </td>
                `;
                employeesTableBody.appendChild(row);
            });
        }

        /**
         * Opens the employee add/edit modal, pre-filling if employeeData is provided.
         * @param {string|null} empId - The ID of the employee to edit, or null for adding a new employee.
         */
        function openEmployeeModal(empId = null) {
            employeeForm.reset(); // Clear previous form data
            employeeIdField.value = ''; // Clear hidden ID field

            if (empId) {
                // Edit mode
                employeeModalTitle.textContent = 'Edit Employee Profile';
                const employee = employees.find(e => e.id === empId);
                if (employee) {
                    document.getElementById('modal-emp-name').value = employee.name;
                    document.getElementById('modal-emp-dob').value = employee.dob;
                    document.getElementById('modal-emp-gender').value = employee.gender;
                    document.getElementById('modal-emp-contact').value = employee.contact;
                    document.getElementById('modal-emp-id').value = employee.nationalId;
                    document.getElementById('modal-emp-kra').value = employee.kraPin;
                    document.getElementById('modal-emp-nhif').value = employee.nhif;
                    document.getElementById('modal-emp-nssf').value = employee.nssf;
                    document.getElementById('modal-emp-department').value = employee.department;
                    document.getElementById('modal-emp-designation').value = employee.designation;
                    document.getElementById('modal-emp-hiredate').value = employee.hireDate;
                    document.getElementById('modal-emp-salary').value = employee.salary;
                    document.getElementById('modal-emp-status').value = employee.status;
                    employeeIdField.value = employee.id; // Set ID after pre-filling
                }
            } else {
                // Add mode
                employeeModalTitle.textContent = 'Add New Employee';
            }
            employeeModal.classList.add('visible');
        }

        /**
         * Closes the employee add/edit modal.
         */
        function closeEmployeeModal() {
            employeeModal.classList.remove('visible');
        }

        /**
         * Handles the submission of the employee form (add or edit).
         * @param {Event} e - The form submission event.
         */
        employeeForm.addEventListener('submit', (e) => {
            e.preventDefault();

            // Basic form validation for non-empty fields
            const requiredFields = employeeForm.querySelectorAll('[required]');
            let allFieldsValid = true;
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.style.borderColor = 'red';
                    allFieldsValid = false;
                } else {
                    field.style.borderColor = ''; // Reset border
                }
            });

            // Validate salary as a positive number
            const salaryInput = document.getElementById('modal-emp-salary');
            if (parseFloat(salaryInput.value) <= 0 || isNaN(parseFloat(salaryInput.value))) {
                salaryInput.style.borderColor = 'red';
                allFieldsValid = false;
            } else {
                 salaryInput.style.borderColor = '';
            }


            if (!allFieldsValid) {
                showMessage('Validation Error', 'Please fill in all required fields and ensure salary is a valid positive number.');
                return;
            }


            const empId = employeeIdField.value;
            const employeeData = {
                name: document.getElementById('modal-emp-name').value,
                dob: document.getElementById('modal-emp-dob').value,
                gender: document.getElementById('modal-emp-gender').value,
                contact: document.getElementById('modal-emp-contact').value,
                nationalId: document.getElementById('modal-emp-id').value,
                kraPin: document.getElementById('modal-emp-kra').value,
                nhif: document.getElementById('modal-emp-nhif').value,
                nssf: document.getElementById('modal-emp-nssf').value,
                department: document.getElementById('modal-emp-department').value,
                designation: document.getElementById('modal-emp-designation').value,
                hireDate: document.getElementById('modal-emp-hiredate').value,
                salary: parseFloat(document.getElementById('modal-emp-salary').value),
                status: document.getElementById('modal-emp-status').value
            };

            if (empId) {
                // Edit existing employee
                const index = employees.findIndex(e => e.id === empId);
                if (index !== -1) {
                    employees[index] = { ...employees[index], ...employeeData };
                    showMessage('Success', `Employee ${employeeData.name} updated successfully.`);
                }
            } else {
                // Add new employee
                employeeData.id = generateUniqueId('EMP');
                employees.push(employeeData);
                showMessage('Success', `Employee ${employeeData.name} added successfully with ID: ${employeeData.id}`);
                addNotification(`New Employee ${employeeData.name} added to HR.`, 'employee');
            }
            saveData('employees', employees);
            populateEmployeeTable();
            closeEmployeeModal();
        });


        /**
         * Simulates deleting an employee.
         * @param {string} empId - The ID of the employee to delete.
         */
        function deleteEmployee(empId) {
            const employeeName = employees.find(emp => emp.id === empId)?.name;
            showMessage(
                'Confirm Delete',
                `Are you sure you want to delete ${employeeName}? This action cannot be undone.`,
                () => {
                    employees = employees.filter(emp => emp.id !== empId);
                    saveData('employees', employees); // Save to LocalStorage
                    populateEmployeeTable();
                    showMessage('Success', `${employeeName} deleted successfully.`);
                    updateDashboardInsights(); // Update dashboard after delete
                }
            );
        }

        // Filters event listeners for employee table
        searchEmployeeNameInput.addEventListener('input', populateEmployeeTable);
        filterDepartmentInput.addEventListener('input', populateEmployeeTable);
        filterStatusSelect.addEventListener('change', populateEmployeeTable);

        // --- Attendance Functions (Shared) ---

        function getCurrentDateTime() {
            const now = new Date();
            const date = now.toISOString().slice(0, 10);
            const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            return { date, time };
        }

        function calculateLateness(checkInTimeStr) {
            const standardShiftStart = new Date();
            standardShiftStart.setHours(8, 0, 0, 0); // 8:00 AM

            const checkInTime = new Date();
            const [hours, minutes, seconds] = checkInTimeStr.split(':').map(Number); // Parse seconds too for accuracy
            checkInTime.setHours(hours, minutes, seconds, 0);

            if (checkInTime > standardShiftStart) {
                const diffMs = checkInTime - standardShiftStart;
                return Math.floor(diffMs / (1000 * 60)); // Lateness in minutes
            }
            return 0;
        }

        function calculateOvertime(checkInTimeStr, checkOutTimeStr) {
            const standardShiftEnd = new Date();
            standardShiftEnd.setHours(17, 0, 0, 0); // 5:00 PM

            const today = new Date().toISOString().slice(0, 10);

            const [inHours, inMinutes, inSeconds] = checkInTimeStr.split(':').map(Number);
            const checkInDate = new Date(`${today}T${inHours}:${inMinutes}:${inSeconds}`);

            const [outHours, outMinutes, outSeconds] = checkOutTimeStr.split(':').map(Number);
            const checkOutDate = new Date(`${today}T${outHours}:${outMinutes}:${outSeconds}`);

            // Ensure checkOutDate is after standardShiftEnd on the same day
            if (checkOutDate > standardShiftEnd) {
                const diffMs = checkOutDate - standardShiftEnd;
                return parseFloat((diffMs / (1000 * 60 * 60)).toFixed(1)); // Overtime in hours
            }
            return 0;
        }

        /**
         * Updates the current day's attendance status displayed on the dashboard.
         * @param {string} empId - The ID of the employee.
         */
        function updateCurrentAttendanceStatus(empId) {
            const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
            let statusForToday = currentEmployeeAttendanceStatus[empId] || { checkedIn: false, checkInTime: null, checkedOut: false, checkOutTime: null, date: today };

            if (!statusForToday.date || statusForToday.date !== today) {
                statusForToday = { checkedIn: false, checkInTime: null, checkedOut: false, checkOutTime: null, date: today };
                currentEmployeeAttendanceStatus[empId] = statusForToday;
            }
            
            if (statusForToday.checkedIn && statusForToday.checkedOut) {
                todayAttendanceStatusSpan.textContent = 'Checked In & Out';
                currentCheckInTimeDisplay.textContent = statusForToday.checkInTime;
                currentCheckOutTimeDisplay.textContent = statusForToday.checkOutTime;
            } else if (statusForToday.checkedIn) {
                todayAttendanceStatusSpan.textContent = 'Checked In';
                currentCheckInTimeDisplay.textContent = statusForToday.checkInTime;
                currentCheckOutTimeDisplay.textContent = '-';
            } else {
                todayAttendanceStatusSpan.textContent = 'Not Checked In';
                currentCheckInTimeDisplay.textContent = '-';
                currentCheckOutTimeDisplay.textContent = '-';
            }

            // Update lateness/overtime display from current day's record if available
            const todayRecord = attendanceRecords.find(rec => rec.empId === empId && rec.date === today);
            overtimeHoursSpan.textContent = todayRecord?.overtime ? `${todayRecord.overtime} hrs` : '0 hrs';
            latenessMinutesSpan.textContent = todayRecord?.lateness ? `${todayRecord.lateness} min` : '0 min';
        }

        /**
         * Populates the attendance history table for a specific employee.
         * @param {string} empId - The ID of the employee.
         */
        function populateAttendanceHistoryTable(empId) {
            attendanceHistoryTableBody.innerHTML = '';
            const employeeAttendance = attendanceRecords.filter(rec => rec.empId === empId);
            if (employeeAttendance.length === 0) {
                attendanceHistoryTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No attendance records found.</td></tr>';
                return;
            }
            employeeAttendance.sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by date descending

            employeeAttendance.forEach(rec => {
                const row = document.createElement('tr');
                let statusColor = 'var(--text-dark)';
                if (rec.status === 'Absent') statusColor = 'red';
                else if (rec.status === 'On Leave') statusColor = 'orange';
                else if (rec.status === 'Present' && rec.lateness > 0) statusColor = 'goldenrod'; // Late but present

                row.innerHTML = `
                    <td>${rec.date}</td>
                    <td>${rec.checkIn || '-'}</td>
                    <td>${rec.checkOut || '-'}</td>
                    <td>${rec.hours ? `${rec.hours} hrs` : '-'}</td>
                    <td><span style="color: ${statusColor}">${rec.status} ${rec.lateness > 0 ? `(Late by ${rec.lateness} min)` : ''}</span></td>
                    <td>${rec.overtime > 0 ? `Overtime: ${rec.overtime} hrs` : ''}</td>
                `;
                attendanceHistoryTableBody.appendChild(row);
            });
        }

        /**
         * Simulates employee check-in.
         */
        function checkIn() {
            const empId = currentUser.empId;
            if (!empId) { showMessage('Error', 'Employee ID not found. Please log in as an employee.'); return; }

            const { date: today, time: checkInTime } = getCurrentDateTime();

            let statusForToday = currentEmployeeAttendanceStatus[empId] || { checkedIn: false, checkInTime: null, checkedOut: false, checkOutTime: null, date: today };
            
            if (!statusForToday.date || statusForToday.date !== today) {
                statusForToday = { checkedIn: false, checkInTime: null, checkedOut: false, checkOutTime: null, date: today };
            }

            if (!statusForToday.checkedIn) {
                statusForToday.checkedIn = true;
                statusForToday.checkInTime = checkInTime;
                currentEmployeeAttendanceStatus[empId] = statusForToday;

                const lateness = calculateLateness(checkInTime);

                const existingRecordIndex = attendanceRecords.findIndex(rec => rec.empId === empId && rec.date === today);
                if (existingRecordIndex !== -1) {
                    attendanceRecords[existingRecordIndex].checkIn = checkInTime;
                    attendanceRecords[existingRecordIndex].status = 'Present';
                    attendanceRecords[existingRecordIndex].lateness = lateness;
                } else {
                    attendanceRecords.push({
                        date: today,
                        empId: empId,
                        checkIn: checkInTime,
                        checkOut: null,
                        hours: null,
                        status: 'Present',
                        lateness: lateness,
                        overtime: 0
                    });
                }
                saveData('attendanceRecords', attendanceRecords); // Save to LocalStorage
                showMessage('Check-In Success', `You have successfully checked in at ${checkInTime}. ${lateness > 0 ? `(You are ${lateness} minutes late.)` : ''}`);
                updateCurrentAttendanceStatus(empId);
                populateAttendanceHistoryTable(empId);
                updateDashboardInsights(); // Update dashboard after check-in
            } else {
                showMessage('Already Checked In', `You already checked in today at ${statusForToday.checkInTime}.`);
            }
        }

        /**
         * Simulates employee check-out.
         */
        function checkOut() {
            const empId = currentUser.empId;
            if (!empId) { showMessage('Error', 'Employee ID not found. Please log in as an employee.'); return; }

            const { date: today, time: checkOutTime } = getCurrentDateTime();

            let statusForToday = currentEmployeeAttendanceStatus[empId] || { checkedIn: false, checkInTime: null, checkedOut: false, checkOutTime: null, date: today };

            if (!statusForToday.date || statusForToday.date !== today) {
                showMessage('Error', 'You must check in before checking out.');
                return;
            }

            if (statusForToday.checkedIn && !statusForToday.checkedOut) {
                statusForToday.checkedOut = checkOutTime;
                currentEmployeeAttendanceStatus[empId] = statusForToday;

                const existingRecordIndex = attendanceRecords.findIndex(rec => rec.empId === empId && rec.date === today);
                if (existingRecordIndex !== -1) {
                    attendanceRecords[existingRecordIndex].checkOut = checkOutTime;
                    // Calculate hours (simple difference, not accounting for breaks)
                    const checkInDate = new Date(`${today}T${statusForToday.checkInTime}`);
                    const checkOutDate = new Date(`${today}T${checkOutTime}`);
                    const hours = (checkOutDate - checkInDate) / (1000 * 60 * 60);
                    attendanceRecords[existingRecordIndex].hours = parseFloat(hours.toFixed(1));
                    attendanceRecords[existingRecordIndex].overtime = calculateOvertime(statusForToday.checkInTime, checkOutTime);
                }
                saveData('attendanceRecords', attendanceRecords); // Save to LocalStorage
                showMessage('Check-Out Success', `You have successfully checked out at ${checkOutTime}.`);
                updateCurrentAttendanceStatus(empId);
                populateAttendanceHistoryTable(empId);
                updateDashboardInsights(); // Update dashboard after check-out
            } else if (!statusForToday.checkedIn) {
                showMessage('Error', 'You must check in before checking out.');
            } else {
                showMessage('Already Checked Out', `You already checked out today at ${statusForToday.checkOutTime}.`);
            }
        }

        // --- Leave Management Functions ---

        /**
         * Populates the employee's leave balances.
         * @param {string} empId - The ID of the employee.
         */
        function populateEmployeeLeaveBalances(empId) {
            // This would fetch actual balances from a backend. For now, static dummy.
            annualLeaveBalanceSpan.textContent = '15';
            sickLeaveBalanceSpan.textContent = '7';
            maternityLeaveBalanceSpan.textContent = '90';
        }

        /**
         * Populates the HR's view of pending leave requests.
         */
        function populateHRLeaveTable() {
            leaveRequestsTableBody.innerHTML = '';
            const hrViewRequests = leaveRequests.filter(req => req.status === 'Pending' || req.status === 'Approved' || req.status === 'Rejected');
            if (hrViewRequests.length === 0) {
                leaveRequestsTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No leave requests found.</td></tr>';
                return;
            }
            hrViewRequests.forEach(req => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${req.reqId}</td>
                    <td>${req.employeeName}</td>
                    <td>${req.type}</td>
                    <td>${req.startDate} to ${req.endDate}</td>
                    <td>${req.reason.substring(0, 30)}${req.reason.length > 30 ? '...' : ''}</td>
                    <td><span style="color: ${req.status === 'Pending' ? 'orange' : (req.status === 'Approved' ? 'green' : 'red')}">${req.status}</span></td>
                    <td>
                        <button class="approve" onclick="approveLeave('${req.reqId}')" ${req.status !== 'Pending' ? 'disabled' : ''}><i class="fas fa-check"></i> Approve</button>
                        <button class="reject" onclick="rejectLeave('${req.reqId}')" ${req.status !== 'Pending' ? 'disabled' : ''}><i class="fas fa-times"></i> Reject</button>
                    </td>
                `;
                leaveRequestsTableBody.appendChild(row);
            });
        }

        /**
         * Populates the employee's own leave history.
         * @param {string} empId - The ID of the employee.
         */
        function populateMyLeaveHistoryTable(empId) {
            myLeaveHistoryTableBody.innerHTML = '';
            const employeeLeaveHistory = leaveRequests.filter(req => req.empId === empId);
            if (employeeLeaveHistory.length === 0) {
                myLeaveHistoryTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No leave history found.</td></tr>';
                return;
            }
            employeeLeaveHistory.sort((a, b) => new Date(b.startDate) - new Date(a.startDate)); // Sort by date descending

            employeeLeaveHistory.forEach(req => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${req.reqId}</td>
                    <td>${req.type}</td>
                    <td>${req.startDate} to ${req.endDate}</td>
                    <td>${req.reason.substring(0, 40)}${req.reason.length > 40 ? '...' : ''}</td>
                    <td><span style="color: ${req.status === 'Pending' ? 'orange' : (req.status === 'Approved' ? 'green' : 'red')}">${req.status}</span></td>
                `;
                myLeaveHistoryTableBody.appendChild(row);
            });
        }


        /**
         * Approves a leave request.
         * @param {string} reqId - The ID of the leave request to approve.
         */
        function approveLeave(reqId) {
            const request = leaveRequests.find(r => r.reqId === reqId);
            if (request) {
                request.status = 'Approved';
                saveData('leaveRequests', leaveRequests); // Save to LocalStorage
                showMessage('Leave Approved', `Leave request for ${request.employeeName} (${request.type}) has been approved.`);
                populateHRLeaveTable(); // Re-render HR table
                updateDashboardInsights(); // Update dashboard
                addNotification(`Leave request for ${request.employeeName} (${request.type}) has been approved.`, 'leave');
            }
        }

        /**
         * Rejects a leave request.
         * @param {string} reqId - The ID of the leave request to reject.
         */
        function rejectLeave(reqId) {
            const request = leaveRequests.find(r => r.reqId === reqId);
            if (request) {
                request.status = 'Rejected';
                saveData('leaveRequests', leaveRequests); // Save to LocalStorage
                showMessage('Leave Rejected', `Leave request for ${request.employeeName} (${request.type}) has been rejected.`);
                populateHRLeaveTable(); // Re-render HR table
                updateDashboardInsights(); // Update dashboard
                addNotification(`Leave request for ${request.employeeName} (${request.type}) has been rejected.`, 'leave');
            }
        }

        /**
         * Handles employee leave request submission.
         * @param {Event} e - The form submission event.
         */
        leaveRequestForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const leaveType = document.getElementById('leave-type').value;
            const startDate = document.getElementById('leave-start-date').value;
            const endDate = document.getElementById('leave-end-date').value;
            const leaveReason = document.getElementById('leave-reason').value;

            if (!leaveType) { showMessage('Validation Error', 'Please select a leave type.'); return; }
            if (new Date(startDate) > new Date(endDate)) { showMessage('Validation Error', 'Start date cannot be after end date.'); return; }

            // Check if required fields are filled
            if (!startDate.trim() || !endDate.trim() || !leaveReason.trim()) {
                showMessage('Validation Error', 'Please fill in all required leave request fields.');
                return;
            }


            const employeeName = employees.find(e => e.id === currentUser.empId)?.name;

            const newLeaveRequest = {
                reqId: generateUniqueId('LR'),
                empId: currentUser.empId,
                employeeName: employeeName,
                type: leaveType,
                startDate: startDate,
                endDate: endDate,
                reason: leaveReason,
                status: 'Pending'
            };
            leaveRequests.push(newLeaveRequest);
            saveData('leaveRequests', leaveRequests); // Save to LocalStorage
            leaveRequestForm.reset();
            populateMyLeaveHistoryTable(currentUser.empId); // Update employee's own history
            showMessage('Leave Request Submitted', `Your leave request for ${leaveType} from ${startDate} to ${endDate} has been submitted for approval. HR will be notified.`);
            updateDashboardInsights(); // Update dashboard
            addNotification(`${employeeName} requested ${leaveType} Leave.`, 'leave');

        });


        // --- Payroll Processing Functions ---

        /**
         * Populates the payroll summary table.
         * @param {string} [empId] - Optional employee ID to filter for individual payslips.
         */
        function populatePayrollSummaryTable(empId = null) {
            payrollSummaryTableBody.innerHTML = '';
            const filterMonthValue = filterPayrollMonthInput.value; // YYYY-MM format

            const filteredPayslips = payslips.filter(ps => {
                const matchesEmployee = !empId || ps.empId === empId;
                const matchesMonth = !filterMonthValue || new Date(ps.month).toISOString().slice(0, 7) === filterMonthValue;
                return matchesEmployee && matchesMonth;
            });

            if (filteredPayslips.length === 0) {
                payrollSummaryTableBody.innerHTML = `<tr><td colspan="7" style="text-align: center;">No payslips available.</td></tr>`;
                return;
            }

            filteredPayslips.sort((a, b) => new Date(b.month) - new Date(a.month)); // Sort by month descending

            filteredPayslips.forEach(ps => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${ps.month}</td>
                    <td>${ps.employeeName}</td>
                    <td>Ksh ${ps.grossPay.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td>Ksh ${(ps.nhif + ps.nssf + ps.paye + (ps.loanRepayment || 0) + (ps.otherDeductions || 0)).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td>Ksh ${ps.netPay.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td><span style="color: green;">${ps.status}</span></td>
                    <td>
                        <button class="primary" onclick="downloadPayslip('${ps.month}', '${ps.empId}')"><i class="fas fa-download"></i> Download</button>
                    </td>
                `;
                payrollSummaryTableBody.appendChild(row);
            });
        }

        /**
         * Simulates monthly payroll processing for HR.
         */
        processPayrollBtn.addEventListener('click', () => {
            const selectedMonth = payrollMonthInput.value; // YYYY-MM format
            if (!selectedMonth) {
                showMessage('Validation Error', 'Please select a month for payroll processing.');
                return;
            }
            const payrollDateFormatted = new Date(selectedMonth + '-01').toLocaleString('en-US', { month: 'long', year: 'numeric' });


            payrollStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing payroll for all active employees...';
            
            setTimeout(() => {
                let processedCount = 0;
                employees.filter(emp => emp.status === 'Active').forEach(emp => {
                    const basicSalary = emp.salary * 0.8; // Example: 80% basic, 20% allowances
                    const houseAllowance = emp.salary * 0.1;
                    const transportAllowance = emp.salary * 0.05;
                    const medicalAllowance = emp.salary * 0.05;
                    const overtimePay = 1500; // Fixed for demo
                    const grossPay = basicSalary + houseAllowance + transportAllowance + medicalAllowance + overtimePay;

                    // Simplified Statutory Deductions (Kenya bands simulated)
                    const nhif = Math.min(1700, Math.ceil(grossPay * 0.02)); // Simplified NHIF
                    const nssf = Math.min(1080, Math.ceil(grossPay * 0.06)); // Simplified NSSF Tier 1

                    // Very simplified PAYE calculation (placeholder for KRA tax bands)
                    let paye = 0;
                    // KRA bands for 2025 (Illustrative, actual values may vary)
                    const band1 = 24000;    // 10%
                    const band2 = 32333 - 24000; // 25% (next 8333)
                    // Above 32333, 30% for illustration

                    if (grossPay <= band1) {
                        paye = grossPay * 0.1;
                    } else if (grossPay <= 32333) {
                        paye = (band1 * 0.1) + ((grossPay - band1) * 0.25);
                    } else {
                        paye = (band1 * 0.1) + (band2 * 0.25) + ((grossPay - 32333) * 0.3);
                    }
                    paye = Math.max(0, Math.round(paye - 2400)); // Less personal relief (Ksh 2400 per month) - simplified, ensuring not negative

                    const loanRepayment = 2500; // Placeholder for SACCO, loans etc.
                    const otherDeductions = 0; // Other deductions
                    const totalDeductions = nhif + nssf + paye + loanRepayment + otherDeductions;
                    const netPay = grossPay - totalDeductions;
                    
                    const newPayslip = {
                        month: payrollDateFormatted,
                        empId: emp.id,
                        employeeName: emp.name,
                        grossPay: grossPay,
                        basicSalary: basicSalary,
                        houseAllowance: houseAllowance,
                        transportAllowance: transportAllowance,
                        medicalAllowance: medicalAllowance,
                        overtimePay: overtimePay,
                        nhif: nhif,
                        nssf: nssf,
                        paye: paye,
                        loanRepayment: loanRepayment,
                        otherDeductions: otherDeductions,
                        netPay: netPay,
                        status: 'Completed'
                    };

                    const existingPayslipIndex = payslips.findIndex(
                        ps => ps.empId === emp.id && ps.month === payrollDateFormatted
                    );

                    if (existingPayslipIndex === -1) {
                         payslips.push(newPayslip);
                    } else {
                        payslips[existingPayslipIndex] = newPayslip;
                    }
                    processedCount++;
                });

                if (processedCount > 0) {
                    saveData('payslips', payslips); // Save to LocalStorage
                    saveData('lastProcessedPayrollMonth', payrollDateFormatted); // Save last processed month
                    payrollStatus.textContent = `Payroll processed successfully for ${payrollDateFormatted}. Payslips generated.`;
                    showMessage('Payroll Success', `Monthly payroll for ${payrollDateFormatted} has been calculated and payslips are generated for ${processedCount} employees.`);
                    populatePayrollSummaryTable(); // Re-render table
                    updateDashboardInsights(); // Update dashboard
                    addNotification(`Monthly Payroll for ${payrollDateFormatted} processed.`, 'payroll');
                } else {
                    payrollStatus.textContent = `No active employees to process payroll for ${payrollDateFormatted}.`;
                    showMessage('Payroll Info', `No active employees found to process payroll for ${payrollDateFormatted}.`);
                }
                // Simulate notifications (Email/WhatsApp/SMS alerts: Payslip ready. Payroll processed.)
                // Simulate M-Pesa API Integration
            }, 1500); // Reduced timeout for quicker processing feedback
        });

        // Event listener for payroll month filter
        filterPayrollMonthInput.addEventListener('change', () => populatePayrollSummaryTable(currentUser.role === 'employee' ? currentUser.empId : null));

        /**
         * Dynamically populates the hidden payslip template with data and generates a PDF.
         * @param {string} month - The month of the payslip (e.g., "July 2025").
         * @param {string} empId - The employee ID.
         */
        function downloadPayslip(month, empId) {
            const payslipData = payslips.find(ps => ps.month === month && ps.empId === empId);
            const employeeData = employees.find(emp => emp.id === empId);

            if (!payslipData || !employeeData) {
                showMessage('Error', 'Payslip data or employee data not found.');
                return;
            }

            // Populate Company Details (static for now)
            // Company name, logo, address, contacts are already in the template with placeholders

            // Populate Employee Details
            payslipMonth.textContent = payslipData.month;
            payslipEmployeeName.textContent = employeeData.name;
            payslipEmployeeId.textContent = employeeData.id;
            payslipDepartment.textContent = employeeData.department;
            payslipPosition.textContent = employeeData.designation;
            payslipPayrollNumber.textContent = employeeData.id; // Using employee ID as payroll number for demo

            // Populate Earnings
            payslipBasicSalary.textContent = (payslipData.basicSalary || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            payslipHouseAllowance.textContent = (payslipData.houseAllowance || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            payslipTransportAllowance.textContent = (payslipData.transportAllowance || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            payslipMedicalAllowance.textContent = (payslipData.medicalAllowance || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            payslipOvertime.textContent = (payslipData.overtimePay || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            // Populate Deductions
            payslipPaye.textContent = (payslipData.paye || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            payslipNhif.textContent = (payslipData.nhif || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            payslipNssf.textContent = (payslipData.nssf || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            payslipLoan.textContent = (payslipData.loanRepayment || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            payslipOtherDeductions.textContent = (payslipData.otherDeductions || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });


            // Populate Summary
            const totalDeductions = (payslipData.nhif || 0) + (payslipData.nssf || 0) + (payslipData.paye || 0) + (payslipData.loanRepayment || 0) + (payslipData.otherDeductions || 0);
            const grossPay = (payslipData.basicSalary || 0) + (payslipData.houseAllowance || 0) + (payslipData.transportAllowance || 0) + (payslipData.medicalAllowance || 0) + (payslipData.overtimePay || 0);

            payslipGrossPay.textContent = grossPay.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            payslipTotalDeductions.textContent = totalDeductions.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            payslipNetPay.textContent = payslipData.netPay.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            // Show the hidden payslip template for rendering
            payslipTemplate.style.display = 'block';

            html2pdf().from(payslipTemplate).save(`Payslip_${employeeData.name.replace(/\s/g, '')}_${month.replace(/\s/g, '')}.pdf`);

            // Hide the payslip template again after generation
            setTimeout(() => {
                payslipTemplate.style.display = 'none';
            }, 100); // Give it a slight delay to ensure rendering is complete before hiding
        }


        // --- Reports Functions (Simulated) ---
        function generateReport(reportType) {
            showMessage('Report Generation', `Simulating generation of '${reportType.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')}' report. (Would show charts/tables here).`);
            // In a real application, this would render data using Chart.js or similar
        }

        function exportReport(reportType, format) {
            showMessage('Report Export', `Simulating export of '${reportType.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')}' report as ${format.toUpperCase()}.`);
            // In a real application, this would trigger a file download
        }

        // --- Profile Management Functions (Employee) ---
        function populateEmployeeProfile(empId) {
            const employee = employees.find(e => e.id === empId);
            if (!employee) {
                showMessage('Error', 'Employee profile not found.');
                return;
            }

            profileName.value = employee.name;
            profileDob.value = employee.dob;
            profileGender.value = employee.gender;
            profileContact.value = employee.contact;
            profileNationalId.value = employee.nationalId;
            profileKra.value = employee.kraPin;
            profileNhif.value = employee.nhif;
            profileNssf.value = employee.nssf;
            profileDepartment.value = employee.department;
            profileDesignation.value = employee.designation;
            profileHireDate.value = employee.hireDate;
            profileStatus.value = employee.status;

            // Make fields editable if they are intended to be updated by employee
            document.querySelectorAll('#profile-section .editable-field').forEach(field => {
                field.removeAttribute('readonly');
            });
        }

        function saveProfileChanges() {
            const empId = currentUser.empId;
            if (!empId) {
                showMessage('Error', 'Employee ID not found for profile update.');
                return;
            }

            const employeeIndex = employees.findIndex(e => e.id === empId);
            if (employeeIndex === -1) {
                showMessage('Error', 'Employee not found.');
                return;
            }

            // Update only editable fields
            employees[employeeIndex].contact = profileContact.value;
            // Add other editable fields here if any, e.g., address if added to schema

            saveData('employees', employees);
            showMessage('Profile Updated', 'Your contact information has been updated successfully.');
            // Re-render dashboard content to update header name if contact impacts it (not in current prototype, but good practice)
            renderDashboardContent(currentUser.role, 'profile-section');
        }


        // --- Authentication and Global Event Listeners ---

        /**
         * Handles the login form submission.
         * Updated: Now allows login based on selected role only, ignoring username/password.
         * @param {Event} e - The form submission event.
         */
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const role = document.getElementById('user-role').value;
            const username = document.getElementById('username').value || role; // Use role as default username

            if (role && role !== "") { // Ensure a role is selected
                // For employee, default to EMP002 (Mwangi Kimani), for HR, set empId to null
                currentUser = { role: role, username: username, empId: (role === 'employee' ? 'EMP002' : null) }; 
                loginContainer.classList.add('hidden');
                appLayout.classList.remove('hidden'); // Show the main app layout
                
                // Populate sidebar based on role
                populateSidebar(role);

                // Set initial dashboard view based on role
                let initialSection = 'dashboard-section';
                if (role === 'employee') {
                    initialSection = 'attendance-section'; // Employee often goes to attendance first
                }
                renderDashboardContent(role, initialSection);

                // Show sidebar toggle button on small screens after login
                if (window.innerWidth <= 768) {
                    sidebarToggleBtn.classList.remove('hidden');
                }

            } else {
                showMessage('Login Failed', 'Please select a role to log in.');
            }
        });

        // Handles sidebar navigation clicks (now handled by `populateSidebar` function)

        /**
         * Handles the logout button click.
         */
        logoutBtn.addEventListener('click', () => {
            currentUser = null; // Clear current user
            appLayout.classList.add('hidden'); // Hide the main app layout
            loginContainer.classList.remove('hidden'); // Show login screen
            loginForm.reset(); // Clear login form fields
            showMessage('Logged Out', 'You have been successfully logged out.');
            
            // Hide sidebar toggle button and sidebar on logout
            sidebarToggleBtn.classList.add('hidden');
            sidebar.classList.remove('visible');
            contentOverlay.classList.add('hidden');
        });

        // Initialize modal's OK button listener
        modalOkBtn.addEventListener('click', () => {
            messageModal.classList.remove('visible');
        });

        // Sidebar toggle for mobile
        sidebarToggleBtn.addEventListener('click', () => {
            sidebar.classList.toggle('visible');
            contentOverlay.classList.toggle('hidden');
        });

        contentOverlay.addEventListener('click', () => {
            sidebar.classList.remove('visible');
            contentOverlay.classList.add('hidden');
        });

        // Profile Dropdown Toggle
        profileDropdownBtn.addEventListener('click', (event) => {
            event.stopPropagation(); // Prevent document click from immediately closing
            profileDropdown.classList.toggle('open');
        });

        // Close profile dropdown if clicking outside
        document.addEventListener('click', (event) => {
            if (!profileDropdown.contains(event.target)) {
                profileDropdown.classList.remove('open');
            }
        });

        // Dark Mode Toggle
        darkModeToggleBtn.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('dark-mode', isDarkMode ? 'enabled' : 'disabled');
            // Update chart colors immediately on toggle
            if (attendanceChartInstance) attendanceChartInstance.update();
            if (payrollPieChartInstance) payrollPieChartInstance.update();
            if (leaveBarChartInstance) leaveBarChartInstance.update();
            darkModeToggleBtn.innerHTML = isDarkMode ? '<i class="fas fa-sun"></i> Light Mode' : '<i class="fas fa-moon"></i> Dark Mode';
        });

        // Check for dark mode preference on load
        function loadDarkModePreference() {
            const darkModePreference = localStorage.getItem('dark-mode');
            if (darkModePreference === 'enabled') {
                document.body.classList.add('dark-mode');
                darkModeToggleBtn.innerHTML = '<i class="fas fa-sun"></i> Light Mode';
            } else {
                darkModeToggleBtn.innerHTML = '<i class="fas fa-moon"></i> Dark Mode';
            }
        }
        loadDarkModePreference();


        // Adjust sidebar visibility on window resize
        window.addEventListener('resize', () => {
            if (window.innerWidth > 768) {
                sidebar.classList.remove('visible');
                contentOverlay.classList.add('hidden');
                sidebarToggleBtn.classList.add('hidden'); // Ensure hidden on desktop
            } else if (currentUser) {
                sidebarToggleBtn.classList.remove('hidden'); // Show if logged in on mobile
            }
        });

        // Set initial values for payroll month inputs
        const todayMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
        payrollMonthInput.value = todayMonth;
        filterPayrollMonthInput.value = todayMonth;

    </script>

</body>
</html>
